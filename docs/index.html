<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>MindTrackAI - Mental Health & Wellness Tracking Platform</title>
  <meta name="description" content="Track your mental health, medication, sleep, exercise, and get personalized wellness insights.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ú®</text></svg>">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1e40af">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MindTrackAI">
  <style>
    /* Dribbble-Inspired Professional Health Dashboard */
    /* Light, minimal design with subtle accents */
    
    /* Light mode (default) - Dribbble style */
    :root{
      --bg:#f8fafc;
      --bg-subtle:#f3f4f6;
      --card:#ffffff;
      --card-hover:#fafbfc;
      --primary:#2563eb;
      --primary-hover:#1d4ed8;
      --primary-light:#3b82f6;
      --accent:#10b981;
      --accent-hover:#059669;
      --warning:#f59e0b;
      --danger:#ef4444;
      --text:#0f172a;
      --text-secondary:#64748b;
      --text-muted:#94a3b8;
      --border:#e5e7eb;
      --border-subtle:#f3f4f6;
      --shadow:rgba(0,0,0,0.04);
      --shadow-md:rgba(0,0,0,0.08);
      --shadow-lg:rgba(0,0,0,0.12);
      --radius:12px;
      --radius-sm:8px;
      --radius-lg:16px;
      --radius-full:9999px;
      --transition:all 0.2s cubic-bezier(0.4,0,0.2,1);
    }
    
    /* Dark mode - Optional, minimal for professionals */
    [data-theme="dark"]{
      --bg:#0f172a;
      --bg-subtle:#1a2332;
      --card:#1e293b;
      --card-hover:#283548;
      --primary:#3b82f6;
      --primary-hover:#2563eb;
      --primary-light:#60a5fa;
      --accent:#10b981;
      --accent-hover:#059669;
      --warning:#f59e0b;
      --danger:#ef4444;
      --text:#f1f5f9;
      --text-secondary:#cbd5e1;
      --text-muted:#94a3b8;
      --border:#334155;
      --border-subtle:#293548;
      --shadow:rgba(0,0,0,0.2);
      --shadow-md:rgba(0,0,0,0.3);
      --shadow-lg:rgba(0,0,0,0.4);
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter','Helvetica Neue',Helvetica,system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-size:15px;
    }
    .container{
      max-width:1280px;
      margin:0 auto;
      padding:1.5rem;
    }

    /* Minimal Header - Logo left, profile right */
    header{
      background:var(--card);
      border-bottom:1px solid var(--border);
      padding:1rem 0;
      position:sticky;
      top:0;
      z-index:100;
      box-shadow:0 1px 3px var(--shadow);
    }
    .header-content{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:.625rem;
      font-size:1.375rem;
      font-weight:700;
      color:var(--primary);
      text-decoration:none;
      letter-spacing:-0.02em;
    }
    .logo:hover{color:var(--primary-hover)}
    .badge{
      background:var(--accent);
      color:#fff;
      padding:.25rem .625rem;
      border-radius:var(--radius-full);
      font-size:.6875rem;
      font-weight:600;
      letter-spacing:0.025em;
      text-transform:uppercase;
    }

    /* Minimal Navigation - Clean tabs */
    .nav-tabs{
      display:flex;
      gap:.375rem;
      flex-wrap:wrap;
    }
    .nav-tab{
      background:transparent;
      border:none;
      color:var(--text-secondary);
      padding:.5rem .875rem;
      border-radius:var(--radius);
      cursor:pointer;
      font-weight:500;
      transition:var(--transition);
      font-size:.875rem;
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .nav-tab:hover{
      color:var(--text);
      background:var(--bg-subtle);
    }
    .nav-tab.active{
      background:var(--primary);
      color:#fff;
      font-weight:600;
    }
    .nav-tab .icon{
      font-size:1.125rem;
      opacity:0;
      width:0;
      overflow:hidden;
    }

    /* Main Content - Grid-based layout */
    main{padding:2rem 0}
    .app-section{display:none}
    .app-section.active{
      display:block;
      animation:fadeIn 0.25s ease-out;
    }

    /* Dashboard Grid Layout */
    .dashboard-grid{
      display:grid;
      gap:1.5rem;
      grid-template-columns:repeat(12,1fr);
    }
    .grid-col-12{grid-column:span 12}
    .grid-col-8{grid-column:span 8}
    .grid-col-6{grid-column:span 6}
    .grid-col-4{grid-column:span 4}
    .grid-col-3{grid-column:span 3}
    @media(max-width:1024px){
      .grid-col-8,.grid-col-6,.grid-col-4,.grid-col-3{grid-column:span 12}
    }

    /* Cards - White, minimal shadow, subtle border */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:1.5rem;
      box-shadow:0 1px 3px var(--shadow);
      transition:var(--transition);
    }
    .card:hover{
      box-shadow:0 4px 12px var(--shadow-md);
    }
    .card-title{
      font-size:1.125rem;
      font-weight:600;
      margin-bottom:1rem;
      color:var(--text);
      letter-spacing:-0.01em;
    }
    .card-compact{padding:1.25rem}
    .card-flat{box-shadow:none}

    /* Forms - Clean, spacious */
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1rem;
    }
    .form-group{margin-bottom:1rem}
    .form-group label{
      display:block;
      font-weight:500;
      margin-bottom:.5rem;
      color:var(--text-secondary);
      font-size:.875rem;
      letter-spacing:0.01em;
    }
    input,select,textarea{
      width:100%;
      padding:.75rem .875rem;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:var(--card);
      color:var(--text);
      font-size:.9375rem;
      transition:var(--transition);
      font-family:inherit;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,0.08);
    }
    input[type="range"]{padding:0}

    /* Buttons - Pill-shaped, flat icons only */
    .btn{
      padding:.625rem 1.25rem;
      border-radius:var(--radius-full);
      font-weight:600;
      cursor:pointer;
      transition:var(--transition);
      border:none;
      font-size:.875rem;
      font-family:inherit;
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      letter-spacing:0.01em;
      justify-content:center;
    }
    .btn-primary{
      background:var(--primary);
      color:#fff;
      box-shadow:0 2px 6px rgba(37,99,235,0.2);
    }
    .btn-primary:hover{
      background:var(--primary-hover);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(37,99,235,0.25);
    }
    .btn-primary:active{transform:translateY(0)}
    .btn-success{
      background:var(--accent);
      color:#fff;
      box-shadow:0 2px 6px rgba(16,185,129,0.2);
    }
    .btn-success:hover{
      background:var(--accent-hover);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(16,185,129,0.25);
    }
    .btn-danger{
      background:var(--danger);
      color:#fff;
    }
    .btn-danger:hover{opacity:0.9}
    .btn-secondary{
      background:var(--card);
      color:var(--text);
      border:1px solid var(--border);
    }
    .btn-secondary:hover{
      border-color:var(--primary);
      color:var(--primary);
      background:var(--bg-subtle);
    }
    .btn-group{
      display:flex;
      gap:.625rem;
      flex-wrap:wrap;
      margin-top:1rem;
    }
    .btn-icon{
      width:2.25rem;
      height:2.25rem;
      padding:0;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }

    /* Mood Slider - Minimal, keep emoji for expression */
    .mood-display{
      font-size:3rem;
      text-align:center;
      margin:1rem 0;
    }
    .mood-scale{
      display:flex;
      justify-content:space-between;
      font-size:.75rem;
      color:var(--text-muted);
      margin-top:.5rem;
      font-weight:500;
    }

    /* Wellness Score - Clean circle */
    .wellness-score{
      text-align:center;
      padding:2rem;
      background:var(--card);
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
    }
    .score-circle{
      width:140px;
      height:140px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 1rem;
      font-size:2.25rem;
      font-weight:700;
      border:5px solid var(--border);
      transition:var(--transition);
    }
    .score-good{border-color:var(--accent);color:var(--accent)}
    .score-medium{border-color:var(--warning);color:var(--warning)}
    .score-low{border-color:var(--danger);color:var(--danger)}
    .score-label{
      font-size:1rem;
      color:var(--text-secondary);
      font-weight:500;
    }

    /* Progress Bars - Flat, clean */
    .progress-bar{
      background:var(--bg-subtle);
      border-radius:var(--radius-full);
      height:8px;
      margin:.5rem 0;
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      border-radius:var(--radius-full);
      transition:width 0.4s cubic-bezier(0.4,0,0.2,1);
    }
    .progress-fill.good{background:var(--accent)}
    .progress-fill.medium{background:var(--warning)}
    .progress-fill.low{background:var(--danger)}

    /* Data List - Clean, minimal */
    .data-list{
      max-height:400px;
      overflow-y:auto;
    }
    .data-item{
      background:var(--card);
      padding:1rem;
      border-radius:var(--radius);
      margin-bottom:.625rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border:1px solid var(--border);
      transition:var(--transition);
    }
    .data-item:hover{
      border-color:var(--primary);
      box-shadow:0 2px 8px var(--shadow-md);
    }
    .data-item-info{flex:1}
    .data-item-title{
      font-weight:600;
      color:var(--text);
      font-size:.9375rem;
    }
    .data-item-meta{
      font-size:.8125rem;
      color:var(--text-muted);
      margin-top:.125rem;
    }
    .data-item-value{
      font-size:1.25rem;
      font-weight:700;
      color:var(--primary);
    }

    /* Stats Grid - Pill-shaped cards */
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:1rem;
      margin-bottom:1.5rem;
    }
    .stat-card{
      background:var(--card);
      padding:1.25rem 1rem;
      border-radius:var(--radius-lg);
      text-align:center;
      border:1px solid var(--border);
      transition:var(--transition);
      box-shadow:0 1px 3px var(--shadow);
    }
    .stat-card:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px var(--shadow-md);
      border-color:var(--primary);
    }
    .stat-value{
      font-size:1.875rem;
      font-weight:700;
      color:var(--primary);
      line-height:1.2;
    }
    .stat-label{
      font-size:.75rem;
      color:var(--text-secondary);
      margin-top:.375rem;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-weight:600;
    }

    /* Medication Grid - Clean status indicators */
    .med-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:1rem;
    }
    .med-card{
      background:var(--card);
      padding:1.125rem;
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      border-left:3px solid var(--primary);
      transition:var(--transition);
      box-shadow:0 1px 3px var(--shadow);
    }
    .med-card:hover{
      border-color:var(--primary);
      box-shadow:0 4px 12px var(--shadow-md);
    }
    .med-card.taken{
      border-left-color:var(--accent);
      opacity:.65;
      background:var(--bg-subtle);
    }
    .med-card.missed{border-left-color:var(--danger)}
    .med-name{
      font-weight:600;
      font-size:1rem;
      color:var(--text);
    }
    .med-time{
      color:var(--text-secondary);
      font-size:.8125rem;
      margin-top:.25rem;
      font-weight:500;
    }

    /* Quiz - Minimal, clean */
    .quiz-question{
      font-size:1.125rem;
      margin-bottom:1.5rem;
      font-weight:600;
      color:var(--text);
    }
    .quiz-options{display:grid;gap:.75rem}
    .quiz-option{
      background:var(--card);
      padding:1rem 1.25rem;
      border-radius:var(--radius);
      cursor:pointer;
      border:1.5px solid var(--border);
      transition:var(--transition);
      font-weight:500;
    }
    .quiz-option:hover{
      border-color:var(--primary);
      background:var(--bg-subtle);
    }
    .quiz-option.correct{
      border-color:var(--accent);
      background:rgba(16,185,129,.08);
    }
    .quiz-option.incorrect{
      border-color:var(--danger);
      background:rgba(239,68,68,.08);
    }
    .quiz-option.selected{border-color:var(--primary);background:var(--bg-subtle)}

    /* Insights - Clean borders for encouragement */
    .insight{
      background:var(--card);
      padding:1rem 1.25rem;
      border-radius:var(--radius);
      margin-bottom:.75rem;
      border-left:3px solid var(--primary);
      transition:var(--transition);
      border:1px solid var(--border);
      border-left-width:3px;
    }
    .insight:hover{
      box-shadow:0 2px 8px var(--shadow-md);
    }
    .insight.positive{border-left-color:var(--accent)}
    .insight.warning{border-left-color:var(--warning)}
    .insight.negative{border-left-color:var(--danger)}

    /* Responsive - Mobile-optimized */
    @media(max-width:768px){
      body{font-size:14px}
      .container{padding:1rem}
      .nav-tabs{display:none}
      .header-content{justify-content:space-between}
      .stats-grid{
        grid-template-columns:repeat(2,1fr);
        gap:.75rem;
      }
      .card{padding:1.25rem}
      main{padding-bottom:80px;padding-top:1.5rem}
      .dashboard-grid{gap:1rem}
      
      /* Mobile: make disclaimer full-width on small screens */
      #medication .disclaimer-info-box{
        grid-column:1/-1 !important;
      }
      #medication > div:first-child{
        grid-template-columns:1fr !important;
      }
    }
    
    /* Mobile Bottom Navigation - Clean, minimal */
    .mobile-bottom-nav{
      display:none;
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:var(--card);
      border-top:1px solid var(--border);
      padding:.875rem .5rem;
      z-index:100;
      box-shadow:0 -2px 12px var(--shadow-md);
    }
    .mobile-bottom-nav .nav-tabs{
      display:flex;
      justify-content:space-around;
      align-items:center;
      gap:.25rem;
      max-width:100%;
    }
    .mobile-bottom-nav .nav-tab{
      flex-direction:column;
      gap:.25rem;
      min-width:0;
      padding:.5rem .25rem;
      font-size:.6875rem;
      border:none;
      background:transparent;
      border-radius:var(--radius);
      font-weight:600;
    }
    .mobile-bottom-nav .nav-tab .icon{
      font-size:1.25rem;
      opacity:1;
      width:auto;
    }
    .mobile-bottom-nav .nav-tab span:not(.icon){
      display:block;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .mobile-bottom-nav .nav-tab.active{
      color:var(--primary);
      background:var(--bg-subtle);
    }
    @media(max-width:768px){.mobile-bottom-nav{display:block}}

    /* Theme Toggle - Minimal */
    .theme-toggle{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text-secondary);
      padding:.5rem;
      border-radius:var(--radius);
      cursor:pointer;
      font-size:1.125rem;
      transition:var(--transition);
      display:flex;
      align-items:center;
      justify-content:center;
      width:2.25rem;
      height:2.25rem;
    }
    .theme-toggle:hover{
      background:var(--bg-subtle);
      border-color:var(--primary);
      color:var(--primary);
    }
    .theme-toggle:focus{
      outline:2px solid var(--primary);
      outline-offset:2px;
    }

    /* Onboarding Modal - Minimal, professional */
    .onboarding-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      backdrop-filter:blur(8px);
      padding:1rem;
    }
    .onboarding-modal{
      background:var(--card);
      border-radius:var(--radius-lg);
      max-width:480px;
      width:90%;
      max-height:90vh;
      box-shadow:0 20px 50px var(--shadow-lg);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      animation:fadeIn 0.3s ease-out;
    }
    .onboarding-header{
      text-align:center;
      padding:2rem 2rem 1rem;
      flex-shrink:0;
    }
    .onboarding-icon{
      font-size:3rem;
      margin-bottom:.75rem;
    }
    .onboarding-title{
      font-size:1.5rem;
      font-weight:700;
      margin-bottom:.5rem;
      color:var(--text);
      letter-spacing:-0.02em;
    }
    .onboarding-subtitle{
      color:var(--text-secondary);
      font-size:.9375rem;
      margin-bottom:1.5rem;
    }
    .onboarding-content{
      padding:0 2rem 1rem;
      overflow-y:auto;
      flex:1;
      min-height:0;
    }
    .onboarding-trackers{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:.875rem;
      margin-bottom:1.5rem;
    }
    .onboarding-tracker{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:.5rem;
      padding:1rem .75rem;
      background:var(--bg-subtle);
      border-radius:var(--radius);
      text-align:center;
      border:1px solid var(--border);
      transition:var(--transition);
    }
    .onboarding-tracker:hover{
      border-color:var(--primary);
      transform:translateY(-2px);
      box-shadow:0 4px 12px var(--shadow-md);
    }
    .onboarding-tracker-icon{
      font-size:2rem;
      flex-shrink:0;
    }
    .onboarding-tracker-title{
      font-weight:600;
      font-size:.875rem;
      line-height:1.3;
      color:var(--text);
    }
    .onboarding-actions{
      display:flex;
      gap:1rem;
      flex-direction:column;
      padding:1rem 2rem 2rem;
      flex-shrink:0;
      background:var(--card);
      border-top:1px solid var(--border);
    }

    /* Profile Section - Primary blue for branding */
    .profile-card{
      background:linear-gradient(135deg,var(--primary) 0%,var(--primary-light) 100%);
      color:#fff;
      padding:1.5rem;
      border-radius:var(--radius-lg);
      margin-bottom:1.5rem;
      display:flex;
      align-items:center;
      gap:1rem;
      box-shadow:0 4px 16px rgba(37,99,235,0.2);
      border:none;
    }
    .profile-avatar{
      width:56px;
      height:56px;
      border-radius:50%;
      background:rgba(255,255,255,.2);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.75rem;
      border:2.5px solid rgba(255,255,255,.3);
    }
    .profile-info{flex:1}
    .profile-name{
      font-size:1.25rem;
      font-weight:700;
      margin-bottom:.25rem;
      letter-spacing:-0.01em;
    }
    .profile-streak{
      font-size:.875rem;
      opacity:.95;
      font-weight:500;
    }
    .profile-actions{display:flex;gap:.5rem}

    /* Wellness Tips - Accent green for encouragement */
    .wellness-tips{
      background:linear-gradient(135deg,var(--accent) 0%,var(--accent-hover) 100%);
      color:#fff;
      padding:1.5rem;
      border-radius:var(--radius-lg);
      margin-bottom:1.5rem;
      box-shadow:0 4px 16px rgba(16,185,129,0.2);
      border:none;
    }
    .wellness-tips-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:1rem;
    }
    .wellness-tips-title{
      font-size:1rem;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .wellness-tips-nav{display:flex;gap:.5rem}
    .wellness-tips-btn{
      background:rgba(255,255,255,.25);
      border:none;
      color:#fff;
      width:2rem;
      height:2rem;
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:var(--transition);
      font-weight:700;
      font-size:.875rem;
    }
    .wellness-tips-btn:hover{
      background:rgba(255,255,255,.4);
      transform:scale(1.08);
    }
    .wellness-tips-content{
      font-size:.9375rem;
      line-height:1.6;
    }

    /* Streak Chart - Minimal, clean */
    .streak-chart{
      display:flex;
      gap:.25rem;
      flex-wrap:wrap;
      justify-content:center;
      margin:1rem 0;
    }
    .streak-day{
      width:12px;
      height:12px;
      border-radius:3px;
      background:var(--border);
      position:relative;
      transition:var(--transition);
    }
    .streak-day.active{background:var(--accent)}
    .streak-day.partial{background:var(--warning)}
    .streak-day:hover{
      transform:scale(1.4);
      z-index:10;
      box-shadow:0 2px 8px var(--shadow-md);
    }
    .streak-day:hover::after{
      content:attr(data-date);
      position:absolute;
      bottom:100%;
      left:50%;
      transform:translateX(-50%);
      background:var(--card);
      color:var(--text);
      padding:.375rem .625rem;
      border-radius:var(--radius-sm);
      font-size:.6875rem;
      white-space:nowrap;
      margin-bottom:.375rem;
      border:1px solid var(--border);
      z-index:100;
      box-shadow:0 4px 12px var(--shadow-md);
      font-weight:500;
    }

    /* Action Buttons - Minimal hover */
    .action-buttons{
      display:flex;
      gap:.625rem;
      margin-top:1rem;
      flex-wrap:wrap;
    }
    .action-btn{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.5rem 1rem;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius-full);
      color:var(--text);
      text-decoration:none;
      font-weight:600;
      transition:var(--transition);
      font-size:.875rem;
      cursor:pointer;
    }
    .action-btn:hover{
      border-color:var(--primary);
      color:var(--primary);
      transform:translateY(-1px);
      box-shadow:0 2px 8px var(--shadow-md);
    }
    .action-btn:focus{
      outline:2px solid var(--primary);
      outline-offset:2px;
    }

    /* SVG Icons */
    .icon-svg{width:18px;height:18px;vertical-align:middle}

    /* Loading State - Subtle */
    .loading{opacity:.5;pointer-events:none}
    .fade-in{animation:fadeIn 0.25s ease-out}
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(8px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    /* Service Worker Animations */
    @keyframes slideIn{
      from{transform:translateX(400px);opacity:0}
      to{transform:translateX(0);opacity:1}
    }
    @keyframes slideOut{
      from{transform:translateX(0);opacity:1}
      to{transform:translateX(400px);opacity:0}
    }

    /* Accessibility - Primary focus states */
    button:focus,
    input:focus,
    select:focus,
    textarea:focus,
    .nav-tab:focus,
    .action-btn:focus{
      outline:2px solid var(--primary);
      outline-offset:2px;
    }
    
    /* Skip link */
    .skip-link{
      position:absolute;
      top:-40px;
      left:0;
      background:var(--primary);
      color:#fff;
      padding:.625rem 1rem;
      text-decoration:none;
      border-radius:0 0 var(--radius) 0;
      z-index:100;
      font-weight:600;
      font-size:.875rem;
    }
    .skip-link:focus{top:0}

    /* Screen reader only */
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border-width:0;
    }

    /* Install PWA - Primary accent */
    .install-pwa{
      display:none;
      position:fixed;
      bottom:1.25rem;
      right:1.25rem;
      background:var(--primary);
      color:#fff;
      padding:.75rem 1.25rem;
      border-radius:var(--radius-full);
      box-shadow:0 4px 16px rgba(37,99,235,0.3);
      cursor:pointer;
      font-weight:700;
      border:none;
      z-index:99;
      transition:var(--transition);
      font-size:.875rem;
    }
    .install-pwa:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(37,99,235,0.35);
      background:var(--primary-hover);
    }
    .install-pwa.show{display:block}

    /* Footer - Minimal */
    footer{
      background:var(--card);
      border-top:1px solid var(--border);
      padding:2rem 0;
      margin-top:3rem;
    }
    .footer-content{
      max-width:1280px;
      margin:0 auto;
      padding:0 1.5rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:1.5rem;
    }
    .footer-left{
      display:flex;
      flex-direction:column;
      gap:.5rem;
    }
    .footer-title{
      font-size:1.125rem;
      font-weight:700;
      color:var(--primary);
      letter-spacing:-0.01em;
    }
    .footer-subtitle{
      color:var(--text-secondary);
      font-size:.875rem;
    }
    .footer-right{
      display:flex;
      gap:.875rem;
      align-items:center;
      flex-wrap:wrap;
    }
    .footer-link{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.5rem 1rem;
      background:var(--bg-subtle);
      border:1px solid var(--border);
      border-radius:var(--radius-full);
      color:var(--text);
      text-decoration:none;
      font-weight:600;
      transition:var(--transition);
      font-size:.875rem;
    }
    .footer-link:hover{
      border-color:var(--primary);
      color:var(--primary);
      transform:translateY(-1px);
      box-shadow:0 2px 8px var(--shadow-md);
    }
    .tech-badge{
      display:inline-block;
      padding:.25rem .625rem;
      background:var(--bg-subtle);
      border:1px solid var(--border);
      border-radius:var(--radius-sm);
      font-size:.6875rem;
      color:var(--text-secondary);
      font-weight:600;
    }
    @media(max-width:768px){
      .footer-content{
        flex-direction:column;
        text-align:center;
        gap:1.25rem;
      }
      .footer-right{justify-content:center}
    }
    
    /* Edit Modal - Clean overlay */
    .modal-overlay{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.65);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:1rem;
      backdrop-filter:blur(8px);
    }
    .modal-content{
      background:var(--card);
      border-radius:var(--radius-lg);
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      overflow-x:visible;
      box-shadow:0 20px 60px var(--shadow-lg);
      border:1px solid var(--border);
      animation:fadeIn 0.25s ease-out;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1.5rem;
      border-bottom:1px solid var(--border);
    }
    .modal-title{
      margin:0;
      font-size:1.25rem;
      color:var(--text);
      font-weight:700;
      letter-spacing:-0.01em;
    }
    .modal-close{
      background:transparent;
      border:none;
      font-size:1.75rem;
      color:var(--text-muted);
      cursor:pointer;
      padding:0;
      width:2rem;
      height:2rem;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:var(--radius);
      transition:var(--transition);
    }
    .modal-close:hover{
      background:var(--bg-subtle);
      color:var(--text);
    }
    .modal-body{
      padding:1.5rem;
      overflow:visible;
    }
    .modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:.75rem;
      padding:1.5rem;
      border-top:1px solid var(--border);
    }
    
    /* Edit/Delete Buttons - Minimal */
    .edit-btn,.delete-btn{
      background:transparent;
      border:1px solid var(--border);
      padding:0.375rem 0.75rem;
      border-radius:var(--radius-full);
      cursor:pointer;
      transition:var(--transition);
      font-size:0.8125rem;
      color:var(--text-secondary);
      display:inline-flex;
      align-items:center;
      gap:0.375rem;
      font-weight:600;
    }
    .edit-btn:hover{
      border-color:var(--primary);
      color:var(--primary);
      background:rgba(37,99,235,0.06);
    }
    .delete-btn:hover{
      border-color:#ef4444;
      color:#ef4444;
      background:rgba(239,68,68,0.06);
    }
    .entry-actions{
      display:flex;
      gap:0.5rem;
      margin-top:0.625rem;
    }
  </style>
</head>

<body>
  <!-- Accessibility: Skip to main content -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Onboarding Modal (shown to first-time users) -->
  <div id="onboardingOverlay" class="onboarding-overlay" style="display:none;" role="dialog" aria-labelledby="onboarding-title" aria-describedby="onboarding-subtitle" aria-modal="true">
    <div class="onboarding-modal">
      <div class="onboarding-header">
        <div class="onboarding-icon" role="img" aria-label="Welcome">‚ú®</div>
        <h2 id="onboarding-title" class="onboarding-title">Welcome to MindTrackAI!</h2>
        <p id="onboarding-subtitle" class="onboarding-subtitle">Your personal health and wellness companion</p>
      </div>
      <div class="onboarding-content">
        <div class="onboarding-trackers">
          <div class="onboarding-tracker">
            <div class="onboarding-tracker-icon" role="img" aria-label="Mental health">üß†</div>
            <div class="onboarding-tracker-title">Mental Health</div>
          </div>
          <div class="onboarding-tracker">
            <div class="onboarding-tracker-icon" role="img" aria-label="Medication">üíä</div>
            <div class="onboarding-tracker-title">Medication</div>
          </div>
          <div class="onboarding-tracker">
            <div class="onboarding-tracker-icon" role="img" aria-label="Sleep">üò¥</div>
            <div class="onboarding-tracker-title">Sleep</div>
          </div>
          <div class="onboarding-tracker">
            <div class="onboarding-tracker-icon" role="img" aria-label="Exercise">üèÉ</div>
            <div class="onboarding-tracker-title">Fitness</div>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label for="userName">What should we call you? (optional)</label>
          <input type="text" id="userName" placeholder="Your name" aria-describedby="userName-desc">
          <small id="userName-desc" class="sr-only">Enter your preferred name for personalization</small>
        </div>
      </div>
      <div class="onboarding-actions">
        <button class="btn btn-primary" onclick="completeOnboarding()" aria-label="Continue to start using MindTrackAI">Continue ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal (reusable for all health logs) -->
  <div id="editModal" class="modal-overlay" style="display:none;" role="dialog" aria-labelledby="edit-modal-title" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="edit-modal-title" class="modal-title">Edit Entry</h2>
        <button class="modal-close" onclick="closeEditModal()" aria-label="Close modal" title="Close">√ó</button>
      </div>
      <div id="editModalBody" class="modal-body">
        <!-- Dynamic content will be inserted here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button id="saveEditBtn" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <header>
    <div class="container">
      <div class="header-content">
        <a href="#" class="logo" aria-label="MindTrackAI home">üß† MindTrackAI <span class="badge">LIVE</span></a>
        <nav class="nav-tabs" role="navigation" aria-label="Main navigation">
          <button class="nav-tab active" data-tab="dashboard" aria-label="Dashboard" aria-current="page"><span class="icon" aria-hidden="true">üìä</span><span>Dashboard</span></button>
          <button class="nav-tab" data-tab="mental" aria-label="Mental Health Tracker"><span class="icon" aria-hidden="true">üß†</span><span>Mental Health</span></button>
          <button class="nav-tab" data-tab="medication" aria-label="Medication Tracker"><span class="icon" aria-hidden="true">üíä</span><span>Medication</span></button>
          <button class="nav-tab" data-tab="sleep" aria-label="Sleep Tracker"><span class="icon" aria-hidden="true">üò¥</span><span>Sleep</span></button>
          <button class="nav-tab" data-tab="exercise" aria-label="Exercise Tracker"><span class="icon" aria-hidden="true">üèÉ</span><span>Exercise</span></button>
        </nav>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark/light mode" title="Toggle theme">
          <span id="themeIcon" aria-hidden="true">üåô</span>
        </button>
      </div>
    </div>
  </header>

  <main id="main-content" class="container" tabindex="-1" role="main" aria-label="Main content">
    <!-- Dashboard -->
    <section id="dashboard" class="app-section active">
      <!-- Profile Card -->
      <div class="profile-card" id="profileCard">
        <div class="profile-avatar" aria-hidden="true">üë§</div>
        <div class="profile-info">
          <div class="profile-name" id="profileName">Welcome!</div>
          <div class="profile-streak" id="profileStreak">Start your wellness journey today</div>
        </div>
        <div class="profile-actions">
          <button class="btn btn-secondary" onclick="editProfile()" aria-label="Edit profile" style="background:rgba(255,255,255,.2);border:none;color:#fff;font-size:.875rem">‚úèÔ∏è Edit</button>
          <button class="btn btn-secondary" onclick="signOut()" aria-label="Sign out and clear all data" style="background:rgba(255,255,255,.2);border:none;color:#fff;font-size:.875rem">üö™ Sign Out</button>
        </div>
      </div>

      <!-- Wellness Tips -->
      <div class="wellness-tips">
        <div class="wellness-tips-header">
          <div class="wellness-tips-title">
            <span aria-hidden="true">üí°</span>
            <span>Wellness Tip of the Day</span>
          </div>
          <div class="wellness-tips-nav">
            <button class="wellness-tips-btn" onclick="previousTip()" aria-label="Previous tip">‚Äπ</button>
            <button class="wellness-tips-btn" onclick="nextTip()" aria-label="Next tip">‚Ä∫</button>
          </div>
        </div>
        <div class="wellness-tips-content" id="wellnessTip" role="region" aria-live="polite">Loading tip...</div>
      </div>

      <div class="wellness-score">
        <div class="score-circle score-medium" id="wellnessCircle" role="img" aria-label="Wellness score">
          <span id="wellnessScore">--</span>
        </div>
        <div class="score-label">Overall Wellness Score</div>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="statMood" aria-live="polite">--</div><div class="stat-label">Mood Today</div></div>
        <div class="stat-card"><div class="stat-value" id="statSleep" aria-live="polite">--</div><div class="stat-label">Hours Sleep</div></div>
        <div class="stat-card"><div class="stat-value" id="statExercise" aria-live="polite">--</div><div class="stat-label">Min Exercise</div></div>
        <div class="stat-card"><div class="stat-value" id="statMeds" aria-live="polite">--</div><div class="stat-label">Meds Taken</div></div>
      </div>

      <div class="card">
        <div class="card-title">üí° Today's Insights</div>
        <div id="insightsList" role="region" aria-live="polite">
          <div class="insight">Log your daily data to see personalized insights!</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">
          <span>üî• Activity Streak</span>
        </div>
        <div class="streak-chart" id="streakChart" role="img" aria-label="30-day activity streak visualization">
          <!-- Streak days will be added by JavaScript -->
        </div>
        <p style="text-align:center;font-size:.875rem;color:var(--muted);margin-top:.5rem">Last 30 days activity ‚Ä¢ Green = Active day</p>
      </div>

      <div class="card">
        <div class="card-title">üìà Weekly Progress</div>
        <div class="form-grid">
          <div>
            <label>üß† Mood</label>
            <div class="progress-bar"><div class="progress-fill good" id="progressMood" style="width:0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Mood progress"></div></div>
          </div>
          <div>
            <label>üò¥ Sleep</label>
            <div class="progress-bar"><div class="progress-fill medium" id="progressSleep" style="width:0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Sleep progress"></div></div>
          </div>
          <div>
            <label>üèÉ Exercise</label>
            <div class="progress-bar"><div class="progress-fill low" id="progressExercise" style="width:0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Exercise progress"></div></div>
          </div>
          <div>
            <label>üíä Medication</label>
            <div class="progress-bar"><div class="progress-fill good" id="progressMeds" style="width:0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Medication adherence"></div></div>
          </div>
        </div>
      </div>

      <!-- Share & Feedback Actions -->
      <div class="card">
        <div class="card-title">üì£ Share & Feedback</div>
        <div class="action-buttons">
          <button class="action-btn" onclick="shareProgress()" aria-label="Share your progress">
            <span aria-hidden="true">üì§</span> Share Progress
          </button>
          <a class="action-btn" href="https://github.com/Isaloum/MindTrackAI/issues/new" target="_blank" rel="noopener noreferrer" aria-label="Send feedback (opens in new tab)">
            <span aria-hidden="true">üí¨</span> Send Feedback
          </a>
          <a class="action-btn" href="https://github.com/Isaloum/MindTrackAI" target="_blank" rel="noopener noreferrer" aria-label="View source code on GitHub (opens in new tab)">
            <span aria-hidden="true">‚≠ê</span> Star on GitHub
          </a>
          <button class="action-btn" onclick="exportData()" aria-label="Export your data">
            <span aria-hidden="true">üíæ</span> Export Data
          </button>
        </div>
      </div>
    </section>

    <!-- Mental Health -->
    <section id="mental" class="app-section">
      <div class="card">
        <div class="card-title">üß† Log Your Mood</div>
        <div class="form-group">
          <label for="moodSlider">How are you feeling today? (1-10)</label>
          <div class="mood-display" id="moodEmoji" role="img" aria-label="Current mood emoji">üòê</div>
          <input type="range" id="moodSlider" min="1" max="10" value="5" aria-valuemin="1" aria-valuemax="10" aria-valuenow="5" aria-label="Mood rating slider">
          <div class="mood-scale"><span>1 - Very Low</span><span>5 - Neutral</span><span>10 - Excellent</span></div>
        </div>
        <div class="form-group">
          <label id="symptoms-label">Any symptoms today?</label>
          <div class="btn-group" role="group" aria-labelledby="symptoms-label">
            <button class="btn btn-secondary symptom-btn" data-symptom="anxiety">üò∞ Anxiety</button>
            <button class="btn btn-secondary symptom-btn" data-symptom="stress">üò´ Stress</button>
            <button class="btn btn-secondary symptom-btn" data-symptom="fatigue">üò¥ Fatigue</button>
            <button class="btn btn-secondary symptom-btn" data-symptom="irritability">üò§ Irritability</button>
            <button class="btn btn-secondary symptom-btn" data-symptom="hopeful">üåü Hopeful</button>
          </div>
        </div>
        <div class="form-group">
          <label>Notes (optional)</label>
          <textarea id="moodNotes" rows="3" placeholder="How was your day?"></textarea>
        </div>
        <button class="btn btn-primary" onclick="saveMood()">üíæ Save Mood Entry</button>
      </div>

      <div class="card">
        <div class="card-title">üìÖ Recent Entries</div>
        <div class="data-list" id="moodHistory"></div>
      </div>
    </section>

    <!-- Medication -->
    <section id="medication" class="app-section">
      <!-- Medical Disclaimer - Subtle info box -->
      <div style="display:grid;grid-template-columns:1fr 380px;gap:1.5rem;margin-bottom:1.5rem;align-items:start">
        <div></div>
        <div class="disclaimer-info-box" style="background:#fff5f5;border:2px solid #ffcccc;border-radius:var(--radius);padding:1rem;box-shadow:0 2px 8px rgba(239,68,68,0.1)">
          <div style="display:flex;align-items:flex-start;gap:0.75rem">
            <div style="flex-shrink:0;width:32px;height:32px;border-radius:50%;background:#ffebee;display:flex;align-items:center;justify-content:center;color:#d63031;font-size:1.25rem;border:2px solid #ffcccc">
              ‚ìò
            </div>
            <div style="flex:1">
              <div style="font-size:0.8125rem;line-height:1.5;color:#2d3436">
                This information is based on available published data. <strong>It should not take the place of medical care and advice from your healthcare provider.</strong> Always consult your doctor before starting, stopping, or changing medications.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üíä Add Medication or Supplement</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Type</label>
            <select id="medType" onchange="updateMedTypePlaceholder()">
              <option value="medication">üíä Medication (Prescription/OTC)</option>
              <option value="supplement">üåø Supplement (Vitamin/Mineral/Herb)</option>
            </select>
            <div style="margin-top:0.375rem;font-size:0.75rem;color:var(--text-secondary)">
              <span id="medTypeHint">Prescription drugs or over-the-counter medications (e.g., Aspirin, Lisinopril)</span>
            </div>
          </div>
          <div class="form-group" style="position:relative;z-index:1001" id="medNameGroup">
            <label>Name</label>
            <input type="text" id="medName" placeholder="e.g., Aspirin" oninput="searchMedication()" autocomplete="off">
            <div id="medSearchResults" style="display:none;position:fixed;z-index:10001">
              <div id="medSearchResultsList" style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:0 4px 12px var(--shadow-md);max-height:200px;overflow-y:auto"></div>
            </div>
            <div id="medInfoBox" style="margin-top:0.5rem;font-size:0.8125rem"></div>
          </div>
          <div class="form-group">
            <label>Dosage</label>
            <input type="text" id="medDosage" placeholder="e.g., 81 mg" oninput="checkDosageRealtime()">
            <div id="dosageWarning" style="margin-top:0.5rem;font-size:0.8125rem;"></div>
          </div>
          <div class="form-group">
            <label>Time</label>
            <select id="medTime">
              <option value="morning">üåÖ Morning</option>
              <option value="afternoon">‚òÄÔ∏è Afternoon</option>
              <option value="evening">üåÜ Evening</option>
              <option value="night">üåô Night</option>
            </select>
          </div>
          
          <!-- Pregnancy Safety Section -->
          <div class="form-group" style="grid-column:1/-1;background:linear-gradient(135deg,#fff5f5,#ffe5e5);padding:1rem;border-radius:var(--radius-sm);border:1px solid #ffcccc">
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.75rem">
              <label style="margin:0;display:flex;align-items:center;gap:0.5rem;cursor:pointer">
                <input type="checkbox" id="isPregnant" onchange="togglePregnancyFields()" style="width:18px;height:18px;cursor:pointer">
                <span style="font-weight:600;color:#d63031">ü§∞ I am pregnant or planning to become pregnant</span>
              </label>
            </div>
            
            <div id="pregnancyFields" style="display:none;margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid #ffcccc">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                <div>
                  <label style="display:block;margin-bottom:0.25rem;font-size:0.875rem;color:#d63031">Week of Pregnancy</label>
                  <input type="number" id="pregnancyWeek" min="1" max="42" placeholder="e.g., 12" style="width:100%;padding:0.5rem;border:1px solid #ffcccc;border-radius:4px">
                  <div style="font-size:0.75rem;color:#666;margin-top:0.25rem">Enter 1-42 weeks</div>
                </div>
                <div>
                  <label style="display:block;margin-bottom:0.25rem;font-size:0.875rem;color:#d63031">Patient ID (Optional)</label>
                  <input type="text" id="pregnancyPatientId" placeholder="For audit logging" style="width:100%;padding:0.5rem;border:1px solid #ffcccc;border-radius:4px">
                  <div style="font-size:0.75rem;color:#666;margin-top:0.25rem">FDA compliance tracking</div>
                </div>
              </div>
              
              <div id="pregnancyWarning" style="margin-top:0.75rem;padding:0.75rem;background:#fff;border-radius:4px;border:2px solid #d63031;display:none">
                <div style="font-weight:600;color:#d63031;margin-bottom:0.5rem">‚ö†Ô∏è PREGNANCY SAFETY WARNING</div>
                <div id="pregnancyWarningContent" style="font-size:0.875rem;color:#2d3436"></div>
              </div>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="addMedication()">‚ûï Add to Tracker</button>
      </div>

      <div class="card">
        <div class="card-title">üìã Today's Medications</div>
        <div class="med-grid" id="medList"></div>
      </div>

      <div class="card">
        <div class="card-title">üåø Supplements</div>
        <div class="med-grid" id="supplementList"></div>
      </div>

      <div class="card">
        <div class="card-title">‚ö†Ô∏è Drug Interaction Warnings</div>
        <div id="interactionWarnings">
          <div class="insight positive">‚úÖ No dangerous interactions detected.</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üåø Supplements</div>
        <div id="supplementList">
          <div class="insight">No supplements tracked. Add a supplement above.</div>
        </div>
      </div>
    </section>

    <!-- Sleep -->
    <section id="sleep" class="app-section">
      <div class="card">
        <div class="card-title">üò¥ Log Sleep</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Bedtime</label>
            <input type="time" id="sleepBedtime" value="22:00">
          </div>
          <div class="form-group">
            <label>Wake Time</label>
            <input type="time" id="sleepWake" value="06:00">
          </div>
          <div class="form-group">
            <label>Sleep Quality (1-10)</label>
            <input type="range" id="sleepQuality" min="1" max="10" value="7">
            <div class="mood-scale"><span>Poor</span><span>Average</span><span>Excellent</span></div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveSleep()">üíæ Save Sleep Entry</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="avgSleep">--</div><div class="stat-label">Avg Hours</div></div>
        <div class="stat-card"><div class="stat-value" id="avgQuality">--</div><div class="stat-label">Avg Quality</div></div>
        <div class="stat-card"><div class="stat-value" id="sleepDebt">--</div><div class="stat-label">Sleep Debt</div></div>
        <div class="stat-card"><div class="stat-value" id="sleepStreak">--</div><div class="stat-label">Day Streak</div></div>
      </div>

      <div class="card">
        <div class="card-title">üìÖ Sleep History</div>
        <div class="data-list" id="sleepHistory"></div>
      </div>
    </section>

    <!-- Exercise -->
    <section id="exercise" class="app-section">
      <div class="card">
        <div class="card-title">üèÉ Log Exercise</div>
        <div class="form-grid">
          <div class="form-group">
            <label>Activity Type</label>
            <select id="exerciseType">
              <option value="walking">üö∂ Walking</option>
              <option value="running">üèÉ Running</option>
              <option value="cycling">üö¥ Cycling</option>
              <option value="swimming">üèä Swimming</option>
              <option value="gym">üèãÔ∏è Gym/Weights</option>
              <option value="yoga">üßò Yoga</option>
              <option value="sports">‚öΩ Sports</option>
              <option value="other">‚ú® Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Duration (minutes)</label>
            <input type="number" id="exerciseDuration" placeholder="30" min="1">
          </div>
          <div class="form-group">
            <label>Intensity</label>
            <select id="exerciseIntensity">
              <option value="light">üòå Light</option>
              <option value="moderate">üí™ Moderate</option>
              <option value="intense">üî• Intense</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary" onclick="saveExercise()">üíæ Log Exercise</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="todayExercise">0</div><div class="stat-label">Min Today</div></div>
        <div class="stat-card"><div class="stat-value" id="weekExercise">0</div><div class="stat-label">Min This Week</div></div>
        <div class="stat-card"><div class="stat-value" id="exerciseGoal">30</div><div class="stat-label">Daily Goal</div></div>
        <div class="stat-card"><div class="stat-value" id="exerciseStreak">0</div><div class="stat-label">Day Streak</div></div>
      </div>

      <div class="card">
        <div class="card-title">üìÖ Exercise History</div>
        <div class="data-list" id="exerciseHistory"></div>
      </div>
    </section>

  </main>

  <!-- Install PWA Button -->
  <button id="installPWA" class="install-pwa" aria-label="Install MindTrackAI as app">
    <span aria-hidden="true">üì±</span> Install App
  </button>

  <!-- Mobile Bottom Navigation -->
  <nav class="mobile-bottom-nav" role="navigation" aria-label="Mobile navigation">
    <button class="mobile-nav-btn active" data-tab="dashboard" aria-label="Dashboard">
      <span class="icon" aria-hidden="true">üìä</span>
      <span class="label">Dashboard</span>
    </button>
    <button class="mobile-nav-btn" data-tab="mental" aria-label="Mental Health">
      <span class="icon" aria-hidden="true">üß†</span>
      <span class="label">Mental</span>
    </button>
    <button class="mobile-nav-btn" data-tab="medication" aria-label="Medication">
      <span class="icon" aria-hidden="true">üíä</span>
      <span class="label">Meds</span>
    </button>
    <button class="mobile-nav-btn" data-tab="sleep" aria-label="Sleep">
      <span class="icon" aria-hidden="true">üò¥</span>
      <span class="label">Sleep</span>
    </button>
    <button class="mobile-nav-btn" data-tab="exercise" aria-label="Exercise">
      <span class="icon" aria-hidden="true">üèÉ</span>
      <span class="label">Exercise</span>
    </button>
  </nav>

  <footer>
    <div class="footer-content">
      <div class="footer-left">
        <div class="footer-title">üß† MindTrackAI</div>
        <div class="footer-subtitle">Built by Ihab Saloum ‚Ä¢ Open Source Project</div>
        <div style="display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap">
          <span class="tech-badge">Node.js</span>
          <span class="tech-badge">JavaScript</span>
          <span class="tech-badge">HTML5</span>
          <span class="tech-badge">1,927 Tests</span>
          <span class="tech-badge">82% Coverage</span>
        </div>
      </div>
      <div class="footer-right">
        <button class="footer-link" onclick="signOut()" style="cursor:pointer" aria-label="Sign out and clear all data">
          <span aria-hidden="true">üö™</span> Sign Out
        </button>
        <a href="https://github.com/Isaloum/MindTrackAI" target="_blank" class="footer-link">
          <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
          View Source Code
        </a>
        <a href="https://github.com/Isaloum" target="_blank" class="footer-link">
          More Projects ‚Üí
        </a>
      </div>
    </div>
  </footer>

  <script>
    // ============================================
    // INITIALIZATION & DEBUG LOGGING
    // ============================================
    console.log('=== MindTrackAI Loading ===');
    console.log('Timestamp:', new Date().toISOString());
    console.log('User Agent:', navigator.userAgent);
    console.log('Document ready state:', document.readyState);
    
    // ============================================
    // WELLNESS TIPS SYSTEM
    // ============================================
    const wellnessTips = [
      "Take 5 deep breaths when feeling stressed. Inhale for 4 counts, hold for 4, exhale for 4.",
      "Stay hydrated! Aim for 8 glasses of water daily for better mood and energy.",
      "Regular exercise releases endorphins - even a 10-minute walk can boost your mood.",
      "Practice gratitude: Write down 3 things you're grateful for each day.",
      "Quality sleep is crucial. Maintain a consistent sleep schedule, even on weekends.",
      "Connect with others. Social support is vital for mental health.",
      "Limit caffeine and alcohol, especially in the evening hours.",
      "Take breaks from screens. Follow the 20-20-20 rule: every 20 minutes, look at something 20 feet away for 20 seconds.",
      "Mindful eating: Eat slowly, savor your food, and listen to your body's hunger cues.",
      "Set realistic goals. Break large tasks into smaller, manageable steps.",
      "Practice self-compassion. Treat yourself with the same kindness you'd offer a friend.",
      "Get some sunlight daily. Natural light helps regulate mood and sleep cycles.",
      "Keep a journal. Writing can help process emotions and reduce stress.",
      "Learn to say no. It's okay to set boundaries and prioritize your wellbeing.",
      "Try progressive muscle relaxation to release physical tension.",
      "Limit news consumption if it increases anxiety. Stay informed, not overwhelmed.",
      "Engage in hobbies you enjoy. Creative activities reduce stress and boost happiness.",
      "Practice mindfulness or meditation for even 5 minutes daily.",
      "Maintain good posture. It can improve mood and energy levels.",
      "Reach out for professional help when needed. It's a sign of strength, not weakness."
    ];
    let currentTipIndex = Math.floor(Math.random() * wellnessTips.length);

    function displayTip() {
      document.getElementById('wellnessTip').textContent = wellnessTips[currentTipIndex];
    }

    function nextTip() {
      currentTipIndex = (currentTipIndex + 1) % wellnessTips.length;
      displayTip();
    }

    function previousTip() {
      currentTipIndex = (currentTipIndex - 1 + wellnessTips.length) % wellnessTips.length;
      displayTip();
    }

    // ============================================
    // THEME TOGGLE SYSTEM
    // ============================================
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
      document.getElementById('themeIcon').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      DB.setOne('theme', newTheme);
      
      // Update Chart.js theme colors
      if (wellnessChart) {
        createWellnessTrendChart();
      }
    }

    function initTheme() {
      const savedTheme = DB.getOne('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('themeIcon').textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
    }

    // ============================================
    // ONBOARDING SYSTEM
    // ============================================
    function showOnboarding() {
      const hasSeenOnboarding = DB.getOne('hasSeenOnboarding');
      if (!hasSeenOnboarding) {
        document.getElementById('onboardingOverlay').style.display = 'flex';
        document.getElementById('userName').focus();
      }
    }

    function completeOnboarding() {
      const userName = document.getElementById('userName').value.trim();
      if (userName) {
        DB.setOne('userName', userName);
      }
      DB.setOne('hasSeenOnboarding', true);
      document.getElementById('onboardingOverlay').style.display = 'none';
      updateProfile();
    }

    // ============================================
    // PROFILE SYSTEM
    // ============================================
    function updateProfile() {
      const userName = DB.getOne('userName') || 'Welcome';
      const moods = DB.get('moods');
      const sleeps = DB.get('sleeps');
      const exercises = DB.get('exercises');
      
      // Calculate streak (consecutive days with any activity)
      const today = new Date();
      let streak = 0;
      for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const dateStr = checkDate.toDateString();
        
        const hasActivity = moods.some(m => new Date(m.date).toDateString() === dateStr) ||
                           sleeps.some(s => new Date(s.date).toDateString() === dateStr) ||
                           exercises.some(e => new Date(e.date).toDateString() === dateStr);
        
        if (hasActivity) {
          streak++;
        } else if (i > 0) {
          // Only break if it's not today (allow today to have no data yet)
          break;
        }
      }

      document.getElementById('profileName').textContent = userName + '!';
      document.getElementById('profileStreak').textContent = streak > 0 ? 
        `üî• ${streak} day${streak !== 1 ? 's' : ''} streak!` : 
        'Start your wellness journey today';
    }

    function editProfile() {
      const currentName = DB.getOne('userName') || '';
      const newName = prompt('What should we call you?', currentName);
      if (newName !== null && newName.trim()) {
        DB.setOne('userName', newName.trim());
        updateProfile();
      }
    }

    // ============================================
    // SIGN OUT SYSTEM
    // ============================================
    function signOut() {
      const confirmation = confirm('Are you sure you want to sign out? This will clear all your data including mood logs, medications, sleep records, and exercise history. This action cannot be undone.');
      
      if (confirmation) {
        // Clear all localStorage data safely
        const keysToRemove = Object.keys(localStorage).filter(key => key.startsWith('stepsync_'));
        
        // Remove all MindTrackAI data
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        // Show success message
        alert('You have been signed out. All data has been cleared. The page will now reload.');
        
        // Reload the page to show onboarding again
        window.location.reload();
      }
    }

    // ============================================
    // STREAK CHART SYSTEM
    // ============================================
    function updateStreakChart() {
      const moods = DB.get('moods');
      const sleeps = DB.get('sleeps');
      const exercises = DB.get('exercises');
      
      const container = document.getElementById('streakChart');
      container.innerHTML = '';
      
      const today = new Date();
      for (let i = 29; i >= 0; i--) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const dateStr = checkDate.toDateString();
        
        // Count activities for this day
        let activityCount = 0;
        if (moods.some(m => new Date(m.date).toDateString() === dateStr)) activityCount++;
        if (sleeps.some(s => new Date(s.date).toDateString() === dateStr)) activityCount++;
        if (exercises.some(e => new Date(e.date).toDateString() === dateStr)) activityCount++;
        // Note: Medications are not tracked historically (design limitation), 
        // so we can't include them in the streak chart
        
        const day = document.createElement('div');
        day.className = 'streak-day';
        if (activityCount >= 3) {
          day.classList.add('active');
        } else if (activityCount > 0) {
          day.classList.add('partial');
        }
        day.setAttribute('data-date', checkDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        day.setAttribute('aria-label', `${checkDate.toLocaleDateString()}: ${activityCount} activities`);
        day.setAttribute('tabindex', '0');
        container.appendChild(day);
      }
    }

    // ============================================
    // SHARE & EXPORT FUNCTIONS
    // ============================================
    function shareProgress() {
      const wellness = document.getElementById('wellnessScore').textContent;
      const text = `I'm tracking my wellness with MindTrackAI! My current wellness score is ${wellness}/100. üß†üí™`;
      
      if (navigator.share) {
        navigator.share({
          title: 'My MindTrackAI Progress',
          text: text,
          url: 'https://isaloum.github.io/MindTrackAI'
        }).catch(err => console.log('Share cancelled'));
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(text + '\nhttps://isaloum.github.io/MindTrackAI')
          .then(() => alert('Progress copied to clipboard! üìã'))
          .catch(() => alert('Share text: ' + text));
      }
    }

    function exportData() {
      const data = {
        profile: {
          name: DB.getOne('userName'),
          exportDate: new Date().toISOString()
        },
        moods: DB.get('moods'),
        medications: DB.get('medications'),
        sleeps: DB.get('sleeps'),
        exercises: DB.get('exercises')
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `stepsync-export-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============================================
    // PWA INSTALLATION
    // ============================================
    let deferredPrompt;
    const installBtn = document.getElementById('installPWA');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.classList.add('show');
    });

    installBtn.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      installBtn.classList.remove('show');
    });

    // Register Service Worker with update notification
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => {
            console.log('[App] Service Worker registered');
            
            // Check for updates every 60 seconds
            setInterval(() => {
              reg.update();
            }, 60000);
            
            // Listen for updates from the service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
              if (event.data && event.data.type === 'SW_UPDATED') {
                console.log('[App] New version available:', event.data.version);
                showUpdateNotification();
              }
            });
          })
          .catch(err => console.log('[App] SW registration failed:', err));
      });
    }

    // Show update notification when new version is available
    function showUpdateNotification() {
      // Check if notification already exists
      if (document.getElementById('sw-update-notification')) return;
      
      const notification = document.createElement('div');
      notification.id = 'sw-update-notification';
      notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 16px;
        animation: slideIn 0.3s ease-out;
      `;
      
      notification.innerHTML = `
        <div style="flex: 1;">
          <strong>‚ú® Update Available</strong>
          <div style="font-size: 14px; opacity: 0.9; margin-top: 4px;">
            A new version of MindTrackAI is ready!
          </div>
        </div>
        <button onclick="location.reload()" style="
          background: white;
          color: var(--primary);
          border: none;
          padding: 8px 16px;
          border-radius: 4px;
          font-weight: 600;
          cursor: pointer;
          transition: transform 0.2s;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          Reload
        </button>
        <button onclick="this.parentElement.remove()" style="
          background: transparent;
          color: white;
          border: 1px solid rgba(255,255,255,0.3);
          padding: 8px 12px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 18px;
          line-height: 1;
        " title="Dismiss">
          √ó
        </button>
      `;
      
      document.body.appendChild(notification);
      
      // Auto-dismiss after 30 seconds if user doesn't interact
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }
      }, 30000);
    }

    // ============================================
    // DATA STORAGE (ORIGINAL)
    // ============================================
    const DB = {
      get: (key) => JSON.parse(localStorage.getItem('stepsync_' + key) || '[]'),
      set: (key, data) => localStorage.setItem('stepsync_' + key, JSON.stringify(data)),
      getOne: (key) => JSON.parse(localStorage.getItem('stepsync_' + key) || 'null'),
      setOne: (key, data) => localStorage.setItem('stepsync_' + key, JSON.stringify(data))
    };

    // Tab Navigation (Desktop)
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        switchTab(tab.dataset.tab);
      });
      
      // Keyboard navigation
      tab.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          tab.click();
        }
      });
    });

    // Tab Navigation (Mobile)
    document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.dataset.tab);
      });
    });

    // Centralized tab switching function
    function switchTab(tabName) {
      // Update desktop nav tabs
      document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.remove('active');
        t.removeAttribute('aria-current');
        if (t.dataset.tab === tabName) {
          t.classList.add('active');
          t.setAttribute('aria-current', 'page');
        }
      });
      
      // Update mobile nav buttons
      document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        }
      });
      
      // Update content sections
      document.querySelectorAll('.app-section').forEach(s => s.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
    }

    // Mood Tracker
    const moodEmojis = ['üò¢','üòû','üòî','üòï','üòê','üôÇ','üòä','üòÑ','üòÅ','ü§©'];
    const moodSlider = document.getElementById('moodSlider');
    const moodEmoji = document.getElementById('moodEmoji');
    let selectedSymptoms = [];

    moodSlider.addEventListener('input', () => {
      const value = parseInt(moodSlider.value);
      moodEmoji.textContent = moodEmojis[value - 1];
      moodSlider.setAttribute('aria-valuenow', value);
    });

    document.querySelectorAll('.symptom-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.classList.toggle('btn-primary');
        btn.classList.toggle('btn-secondary');
        const symptom = btn.dataset.symptom;
        if (selectedSymptoms.includes(symptom)) {
          selectedSymptoms = selectedSymptoms.filter(s => s !== symptom);
        } else {
          selectedSymptoms.push(symptom);
        }
      });
    });

    function saveMood() {
      const entry = {
        date: new Date().toISOString(),
        mood: parseInt(moodSlider.value),
        symptoms: [...selectedSymptoms],
        notes: document.getElementById('moodNotes').value
      };
      const moods = DB.get('moods');
      moods.unshift(entry);
      DB.set('moods', moods.slice(0, 100));
      document.getElementById('moodNotes').value = '';
      selectedSymptoms = [];
      document.querySelectorAll('.symptom-btn').forEach(b => {
        b.classList.remove('btn-primary');
        b.classList.add('btn-secondary');
      });
      alert('Mood saved! üéâ');
      loadMoodHistory();
      updateDashboard();
    }

    // ============================================
    // EDIT MODAL SYSTEM (for all health logs)
    // ============================================
    let currentEditType = null;
    let currentEditId = null;

    function openEditModal(type, id) {
      currentEditType = type;
      currentEditId = id;
      const modal = document.getElementById('editModal');
      const modalBody = document.getElementById('editModalBody');
      const modalTitle = document.getElementById('edit-modal-title');
      
      if (type === 'mood') {
        const moods = DB.get('moods');
        const mood = moods.find(m => m.date === id);
        if (!mood) return;
        
        modalTitle.textContent = 'Edit Mood Entry';
        modalBody.innerHTML = `
          <div class="form-group">
            <label for="editMoodSlider">How are you feeling? (1-10)</label>
            <div style="text-align:center;font-size:4rem;margin:1rem 0" id="editMoodEmoji">${moodEmojis[mood.mood - 1]}</div>
            <input type="range" id="editMoodSlider" min="1" max="10" value="${mood.mood}" class="mood-slider" oninput="document.getElementById('editMoodEmoji').textContent = moodEmojis[this.value - 1]">
            <div style="display:flex;justify-content:space-between;margin-top:0.5rem;font-size:0.875rem;color:var(--muted)">
              <span>1 - Very Low</span>
              <span>5 - Neutral</span>
              <span>10 - Excellent</span>
            </div>
          </div>
          <div class="form-group">
            <label>Symptoms (optional)</label>
            <div style="display:flex;flex-wrap:wrap;gap:0.5rem">
              ${['Anxiety', 'Stress', 'Fatigue', 'Irritability', 'Hopeful'].map(s => `
                <button class="symptom-btn ${mood.symptoms.includes(s) ? 'btn-primary' : 'btn-secondary'}" data-symptom="${s}" onclick="this.classList.toggle('btn-primary'); this.classList.toggle('btn-secondary')">
                  ${s}
                </button>
              `).join('')}
            </div>
          </div>
          <div class="form-group">
            <label for="editMoodNotes">Notes (optional)</label>
            <textarea id="editMoodNotes" placeholder="How was your day?" rows="3">${mood.notes || ''}</textarea>
          </div>
        `;
      } else if (type === 'sleep') {
        const sleeps = DB.get('sleeps');
        const sleep = sleeps.find(s => s.date === id);
        if (!sleep) return;
        
        modalTitle.textContent = 'Edit Sleep Entry';
        modalBody.innerHTML = `
          <div class="form-group">
            <label for="editSleepBedtime">Bedtime</label>
            <input type="time" id="editSleepBedtime" value="${sleep.bedtime}" required>
          </div>
          <div class="form-group">
            <label for="editSleepWake">Wake Time</label>
            <input type="time" id="editSleepWake" value="${sleep.wake}" required>
          </div>
          <div class="form-group">
            <label for="editSleepQuality">Sleep Quality (1-10): <span id="editQualityValue">${sleep.quality}</span></label>
            <input type="range" id="editSleepQuality" min="1" max="10" value="${sleep.quality}" oninput="document.getElementById('editQualityValue').textContent = this.value">
          </div>
        `;
      } else if (type === 'exercise') {
        const exercises = DB.get('exercises');
        const exercise = exercises.find(e => e.date === id);
        if (!exercise) return;
        
        modalTitle.textContent = 'Edit Exercise Entry';
        modalBody.innerHTML = `
          <div class="form-group">
            <label for="editExerciseType">Activity Type</label>
            <select id="editExerciseType">
              <option value="Walking" ${exercise.type === 'Walking' ? 'selected' : ''}>üö∂ Walking</option>
              <option value="Running" ${exercise.type === 'Running' ? 'selected' : ''}>üèÉ Running</option>
              <option value="Cycling" ${exercise.type === 'Cycling' ? 'selected' : ''}>üö¥ Cycling</option>
              <option value="Swimming" ${exercise.type === 'Swimming' ? 'selected' : ''}>üèä Swimming</option>
              <option value="Yoga" ${exercise.type === 'Yoga' ? 'selected' : ''}>üßò Yoga</option>
              <option value="Gym" ${exercise.type === 'Gym' ? 'selected' : ''}>üèãÔ∏è Gym</option>
              <option value="Sports" ${exercise.type === 'Sports' ? 'selected' : ''}>‚öΩ Sports</option>
              <option value="Other" ${exercise.type === 'Other' ? 'selected' : ''}>üí™ Other</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editExerciseDuration">Duration (minutes)</label>
            <input type="number" id="editExerciseDuration" min="1" value="${exercise.duration}" required>
          </div>
          <div class="form-group">
            <label for="editExerciseIntensity">Intensity</label>
            <select id="editExerciseIntensity">
              <option value="Low" ${exercise.intensity === 'Low' ? 'selected' : ''}>Low</option>
              <option value="Moderate" ${exercise.intensity === 'Moderate' ? 'selected' : ''}>Moderate</option>
              <option value="High" ${exercise.intensity === 'High' ? 'selected' : ''}>High</option>
            </select>
          </div>
        `;
      }
      
      modal.style.display = 'flex';
      // Focus first input for accessibility
      setTimeout(() => {
        const firstInput = modalBody.querySelector('input, select, textarea');
        if (firstInput) firstInput.focus();
      }, 100);
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditType = null;
      currentEditId = null;
    }

    function saveEdit() {
      if (!currentEditType || !currentEditId) return;
      
      if (currentEditType === 'mood') {
        const moods = DB.get('moods');
        const index = moods.findIndex(m => m.date === currentEditId);
        if (index === -1) return;
        
        const moodValue = parseInt(document.getElementById('editMoodSlider').value);
        const symptoms = Array.from(document.querySelectorAll('.symptom-btn.btn-primary')).map(btn => btn.dataset.symptom);
        const notes = document.getElementById('editMoodNotes').value;
        
        moods[index] = {
          ...moods[index],
          mood: moodValue,
          symptoms: symptoms,
          notes: notes
        };
        
        DB.set('moods', moods);
        loadMoodHistory();
        updateDashboard();
        
      } else if (currentEditType === 'sleep') {
        const sleeps = DB.get('sleeps');
        const index = sleeps.findIndex(s => s.date === currentEditId);
        if (index === -1) return;
        
        const bedtime = document.getElementById('editSleepBedtime').value;
        const wake = document.getElementById('editSleepWake').value;
        const quality = parseInt(document.getElementById('editSleepQuality').value);
        
        const bedDate = new Date(`2000-01-01T${bedtime}`);
        let wakeDate = new Date(`2000-01-01T${wake}`);
        if (wakeDate < bedDate) wakeDate.setDate(wakeDate.getDate() + 1);
        const hours = (wakeDate - bedDate) / (1000 * 60 * 60);
        
        sleeps[index] = {
          ...sleeps[index],
          bedtime: bedtime,
          wake: wake,
          hours: Math.round(hours * 10) / 10,
          quality: quality
        };
        
        DB.set('sleeps', sleeps);
        loadSleepData();
        updateDashboard();
        
      } else if (currentEditType === 'exercise') {
        const exercises = DB.get('exercises');
        const index = exercises.findIndex(e => e.date === currentEditId);
        if (index === -1) return;
        
        exercises[index] = {
          ...exercises[index],
          type: document.getElementById('editExerciseType').value,
          duration: parseInt(document.getElementById('editExerciseDuration').value),
          intensity: document.getElementById('editExerciseIntensity').value
        };
        
        DB.set('exercises', exercises);
        loadExerciseData();
        updateDashboard();
      }
      
      closeEditModal();
    }

    // Delete functions for each log type
    function deleteMoodEntry(id) {
      if (!confirm('Delete this mood entry? This cannot be undone.')) return;
      const moods = DB.get('moods').filter(m => m.date !== id);
      DB.set('moods', moods);
      loadMoodHistory();
      updateDashboard();
    }

    function deleteSleepEntry(id) {
      if (!confirm('Delete this sleep entry? This cannot be undone.')) return;
      const sleeps = DB.get('sleeps').filter(s => s.date !== id);
      DB.set('sleeps', sleeps);
      loadSleepData();
      updateDashboard();
    }

    function deleteExerciseEntry(id) {
      if (!confirm('Delete this exercise entry? This cannot be undone.')) return;
      const exercises = DB.get('exercises').filter(e => e.date !== id);
      DB.set('exercises', exercises);
      loadExerciseData();
      updateDashboard();
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('editModal').style.display === 'flex') {
        closeEditModal();
      }
    });

    // Close modal on background click
    document.getElementById('editModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'editModal') {
        closeEditModal();
      }
    });

    // ============================================
    // THEME TOGGLE FUNCTION - Duplicate removed (use one at line ~1643)
    // ============================================

    // ============================================
    // MEDICATION API INTEGRATION (FDA + NIH)
    // ============================================
    
    // Medication search cache to reduce API calls
    const MED_CACHE = {
      rxnorm: {},
      fda: {},
      interactions: {}
    };
    
    // Local medication database (55 medications)
    let LOCAL_MEDICATIONS_DB = null;
    
    // Load local medications database
    async function loadLocalMedicationsDB() {
      if (LOCAL_MEDICATIONS_DB) return LOCAL_MEDICATIONS_DB;
      
      try {
        const response = await fetch('medications-db.json');
        if (!response.ok) throw new Error('Failed to load local medications database');
        const data = await response.json();
        LOCAL_MEDICATIONS_DB = data.medications || [];
        console.log('‚úì Loaded local medications database:', LOCAL_MEDICATIONS_DB.length, 'medications');
        return LOCAL_MEDICATIONS_DB;
      } catch (error) {
        console.warn('‚ö†Ô∏è Could not load local medications database:', error.message);
        LOCAL_MEDICATIONS_DB = [];
        return [];
      }
    }
    
    // Search local medications database with fuzzy matching
    function searchLocalMedications(query) {
      if (!LOCAL_MEDICATIONS_DB || !query) return [];
      
      const searchTerm = query.toLowerCase().trim();
      const results = [];
      
      LOCAL_MEDICATIONS_DB.forEach(med => {
        let score = 0;
        const name = (med.name || '').toLowerCase();
        const genericName = (med.genericName || '').toLowerCase();
        const brandNames = (med.brandNames || []).map(b => b.toLowerCase());
        
        // Exact match gets highest priority
        if (name === searchTerm || genericName === searchTerm) {
          score = 1000;
        }
        // Starts with search term
        else if (name.startsWith(searchTerm) || genericName.startsWith(searchTerm)) {
          score = 500;
        }
        // Contains search term
        else if (name.includes(searchTerm) || genericName.includes(searchTerm)) {
          score = 100;
        }
        
        // Check brand names
        brandNames.forEach(brand => {
          if (brand === searchTerm) score = Math.max(score, 900);
          else if (brand.startsWith(searchTerm)) score = Math.max(score, 400);
          else if (brand.includes(searchTerm)) score = Math.max(score, 50);
        });
        
        if (score > 0) {
          results.push({ medication: med, score: score });
        }
      });
      
      // Sort by score (highest first) and return medications
      return results
        .sort((a, b) => b.score - a.score)
        .slice(0, 10)
        .map(r => r.medication);
    }
    
    // Update placeholder text based on medication type
    function updateMedTypePlaceholder() {
      const type = document.getElementById('medType').value;
      const nameInput = document.getElementById('medName');
      const dosageInput = document.getElementById('medDosage');
      const hint = document.getElementById('medTypeHint');
      
      if (type === 'medication') {
        nameInput.placeholder = 'e.g., Aspirin, Lisinopril, Metformin';
        dosageInput.placeholder = 'e.g., 81 mg, 10 mg';
        hint.textContent = 'Prescription drugs or over-the-counter medications (e.g., Aspirin, Lisinopril)';
      } else {
        nameInput.placeholder = 'e.g., Vitamin D, Fish Oil, Magnesium';
        dosageInput.placeholder = 'e.g., 1000 IU, 500 mg';
        hint.textContent = 'Vitamins, minerals, herbs, or other dietary supplements';
      }
    }
    
    // Search medication using local database first, then RxNorm API fallback
    // Version: 2026-01-12 - Enhanced with local database integration
    let searchTimeout;
    window.searchMedication = async function searchMedication() {
      console.log('=== searchMedication called ===');
      console.log('Timestamp:', new Date().toISOString());
      
      clearTimeout(searchTimeout);
      
      const medNameInput = document.getElementById('medName');
      const resultsContainer = document.getElementById('medSearchResults');
      const resultsList = document.getElementById('medSearchResultsList');
      
      if (!medNameInput || !resultsContainer || !resultsList) {
        console.error('‚ùå CRITICAL: Required elements not found!');
        return;
      }
      
      const query = medNameInput.value.trim();
      console.log('Search query:', query, 'Length:', query.length);
      
      if (query.length < 2) {
        console.log('Query too short (<2 chars), hiding dropdown');
        resultsContainer.style.display = 'none';
        return;
      }
      
      console.log('‚úì Query length OK (>=2 chars), starting search...');
      
      searchTimeout = setTimeout(async () => {
        console.log('Timeout triggered, executing search...');
        try {
          // Load local database if not loaded
          await loadLocalMedicationsDB();
          
          // Search local database first
          const localResults = searchLocalMedications(query);
          console.log('‚úì Local database search found:', localResults.length, 'results');
          
          if (localResults.length > 0) {
            // Display local results with enhanced formatting
            displayLocalMedicationResults(localResults);
            return;
          }
          
          // If no local results, fall back to RxNorm API
          console.log('No local results, falling back to RxNorm API...');
          
          // Check cache first
          if (MED_CACHE.rxnorm[query]) {
            console.log('‚úì Found in cache:', MED_CACHE.rxnorm[query].length, 'results');
            displaySearchResults(MED_CACHE.rxnorm[query]);
            return;
          }
          
          const url = `https://rxnav.nlm.nih.gov/REST/approximateTerm.json?term=${encodeURIComponent(query)}&maxEntries=5`;
          console.log('Fetching from RxNorm API:', url);
          
          const response = await fetch(url);
          console.log('Response received - Status:', response.status, 'OK:', response.ok);
          
          if (!response.ok) {
            console.warn('‚ö†Ô∏è API response not OK:', response.status);
            resultsContainer.style.display = 'block';
            resultsList.innerHTML = '<div style="color:#ef4444;padding:0.75rem">‚ö†Ô∏è Unable to reach RxNorm API. Please check your internet connection or try again later.</div>';
            return;
          }
          
          const data = await response.json();
          console.log('‚úì API data received:', data);
          
          const candidates = data.approximateGroup?.candidate || [];
          console.log('‚úì Candidates found:', candidates.length);
          
          // Cache the results
          MED_CACHE.rxnorm[query] = candidates;
          
          // Display results
          displaySearchResults(candidates);
          
        } catch (error) {
          console.error('‚ùå Search Error:', error);
          resultsContainer.style.display = 'block';
          resultsList.innerHTML = '<div style="color:#ef4444;padding:0.75rem">‚ö†Ô∏è Error searching for medication. Please try again later.</div>';
        }
      }, 300);
      
      console.log('=== searchMedication end ===');
    }
    
    // Display local medication search results with enhanced formatting
    function displayLocalMedicationResults(medications) {
      console.log('=== displayLocalMedicationResults called ===');
      console.log('Medications received:', medications.length);
      
      const container = document.getElementById('medSearchResults');
      const resultsList = document.getElementById('medSearchResultsList');
      const inputField = document.getElementById('medName');
      
      if (!container || !resultsList) {
        console.error('‚ùå CRITICAL: Required elements not found!');
        return;
      }
      
      if (!medications || medications.length === 0) {
        resultsList.innerHTML = '<div style="padding:0.75rem;color:var(--text-secondary);text-align:center">No medications found in database.</div>';
        container.style.display = 'block';
        return;
      }
      
      // Position dropdown below input field
      const rect = inputField.getBoundingClientRect();
      container.style.top = (rect.bottom + 4) + 'px';
      container.style.left = rect.left + 'px';
      container.style.width = rect.width + 'px';
      
      // Build results HTML with enhanced styling
      const htmlParts = [];
      medications.forEach((med, index) => {
        const name = med.name || '';
        const genericName = med.genericName || '';
        const brandNames = (med.brandNames || []).join(', ');
        const category = med.category || '';
        const dosages = (med.dosages || []).join(', ');
        
        // Category badge color
        const categoryColors = {
          'SSRI': '#3b82f6',
          'SNRI': '#8b5cf6',
          'Benzodiazepine': '#ef4444',
          'Atypical Antidepressant': '#10b981',
          'Tricyclic Antidepressant': '#f59e0b',
          'Atypical Antipsychotic': '#ec4899',
          'Typical Antipsychotic': '#ef4444',
          'Mood Stabilizer': '#06b6d4',
          'Stimulant': '#f97316',
          'Anticonvulsant': '#14b8a6',
          'Beta-Blocker': '#6366f1'
        };
        const categoryColor = categoryColors[category] || '#64748b';
        
        // Escape for safety
        const safeName = String(name).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
        const safeGenericName = String(genericName).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
        const safeBrandNames = String(brandNames).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
        const safeCategory = String(category).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
        
        // Store medication data as JSON in data attribute
        const medDataJson = JSON.stringify(med).replace(/"/g, '&quot;');
        
        htmlParts.push(`
        <div data-medication='${medDataJson}'
             style="padding:0.75rem;cursor:pointer;border-bottom:1px solid var(--border);transition:var(--transition)" 
             onmouseover="this.style.background='var(--bg-subtle)'"
             onmouseout="this.style.background='transparent'"
             onclick="selectLocalMedication(this)">
          <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.25rem">
            <div style="font-weight:600;color:var(--text);flex:1">${safeName}</div>
            <span style="font-size:0.625rem;padding:0.125rem 0.375rem;background:${categoryColor};color:white;border-radius:4px;font-weight:500">${safeCategory}</span>
          </div>
          ${brandNames ? `<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.125rem">Brand: ${safeBrandNames}</div>` : ''}
          ${dosages ? `<div style="font-size:0.7rem;color:var(--text-muted)">Dosages: ${dosages}</div>` : ''}
        </div>
      `);
      });
      
      resultsList.innerHTML = htmlParts.join('');
      container.style.display = 'block';
      
      console.log('=== displayLocalMedicationResults complete ===');
    }
    
    function displaySearchResults(candidates) {
      console.log('=== displaySearchResults called ===');
      console.log('Candidates received:', candidates);
      console.log('Candidates count:', candidates ? candidates.length : 0);
      
      const container = document.getElementById('medSearchResults');
      const resultsList = document.getElementById('medSearchResultsList');
      const inputField = document.getElementById('medName');
      
      console.log('Container element:', container);
      console.log('Container display before:', container ? container.style.display : 'N/A');
      console.log('ResultsList element:', resultsList);
      
      if (!container) {
        console.error('‚ùå CRITICAL: medSearchResults container not found!');
        return;
      }
      
      if (!resultsList) {
        console.error('‚ùå CRITICAL: medSearchResultsList element not found!');
        return;
      }
      
      if (!candidates || candidates.length === 0) {
        console.log('No candidates found, showing "no results" message');
        resultsList.innerHTML = '<div style="padding:0.75rem;color:var(--text-secondary);text-align:center">No medications found. Try a different search term.</div>';
        container.style.display = 'block';
        console.log('Container display set to: block (no results message)');
        return;
      }
      
      // Position dropdown below input field
      const rect = inputField.getBoundingClientRect();
      container.style.top = (rect.bottom + 4) + 'px';
      container.style.left = rect.left + 'px';
      container.style.width = rect.width + 'px';
      
      console.log('Building results HTML for', candidates.length, 'candidates');
      const htmlParts = [];
      candidates.slice(0, 5).forEach((c, index) => {
        console.log(`  Candidate ${index}:`, c);
        // RxNorm API returns either c.candidate OR c.name depending on the endpoint
        const medName = c.candidate || c.name;
        const medRxcui = c.rxcui;
        
        if (!c || !medName || !medRxcui) {
          console.warn(`  Skipping invalid candidate at index ${index}:`, {
            hasCandidate: !!c?.candidate,
            hasName: !!c?.name,
            hasRxcui: !!c?.rxcui
          });
          return;
        }
        
        const safeCandidate = String(medName).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
        const safeRxCUI = String(medRxcui).replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
        htmlParts.push(`
        <div data-candidate="${safeCandidate}" data-rxcui="${safeRxCUI}" 
             style="padding:0.625rem 0.75rem;cursor:pointer;border-bottom:1px solid var(--border);transition:var(--transition)" 
             onmouseover="this.style.background='var(--bg-subtle)'"
             onmouseout="this.style.background='transparent'"
             onclick="selectMedicationFromData(this)">
          <div style="font-weight:600;color:var(--text)">${safeCandidate}</div>
          <div style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.125rem">RxCUI: ${safeRxCUI}</div>
        </div>
      `);
      });
      
      resultsList.innerHTML = htmlParts.join('');
      console.log('‚úì HTML set, innerHTML length:', resultsList.innerHTML.length);
      
      // Force display
      container.style.display = 'block';
      console.log('‚úì Container display set to: block');
      console.log('Container display after:', container.style.display);
      console.log('Container computed style:', window.getComputedStyle(container).display);
      console.log('Container visibility:', window.getComputedStyle(container).visibility);
      console.log('Container opacity:', window.getComputedStyle(container).opacity);
      console.log('Container position:', window.getComputedStyle(container).position);
      console.log('Container z-index:', window.getComputedStyle(container).zIndex);
      
      console.log('=== displaySearchResults complete - Dropdown should be visible! ===');
    }
    
    // Select medication from local database
    function selectLocalMedication(element) {
      console.log('=== selectLocalMedication called ===');
      try {
        const medDataJson = element.getAttribute('data-medication');
        const medication = JSON.parse(medDataJson.replace(/&quot;/g, '"'));
        console.log('Selected medication:', medication);
        
        // Populate medication name
        document.getElementById('medName').value = medication.name;
        document.getElementById('medSearchResults').style.display = 'none';
        
        // Store medication data for later use
        document.getElementById('medName').setAttribute('data-medication', JSON.stringify(medication));
        document.getElementById('medName').setAttribute('data-rxcui', medication.rxnormId || '');
        
        // Populate dosage dropdown dynamically
        populateDosageDropdown(medication);
        
        // Display medication information
        displayMedicationInfo(medication);
        
      } catch (error) {
        console.error('‚ùå Error selecting medication:', error);
      }
    }
    
    // Populate dosage dropdown based on selected medication
    function populateDosageDropdown(medication) {
      console.log('=== populateDosageDropdown called ===');
      const dosageContainer = document.querySelector('#medDosage').parentElement;
      const dosageInput = document.getElementById('medDosage');
      
      if (!medication.dosages || medication.dosages.length === 0) {
        // No dosages available, keep as text input
        console.log('No dosages available for this medication');
        return;
      }
      
      // Replace text input with dropdown
      const dosageDropdown = document.createElement('select');
      dosageDropdown.id = 'medDosage';
      dosageDropdown.style.cssText = dosageInput.style.cssText;
      
      // Add default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select dosage...';
      dosageDropdown.appendChild(defaultOption);
      
      // Add dosage options from database
      medication.dosages.forEach(dosage => {
        const option = document.createElement('option');
        option.value = dosage;
        option.textContent = dosage;
        dosageDropdown.appendChild(option);
      });
      
      // Add custom dosage option
      const customOption = document.createElement('option');
      customOption.value = 'custom';
      customOption.textContent = 'Other (specify below)';
      dosageDropdown.appendChild(customOption);
      
      // Add event listener for custom dosage
      dosageDropdown.addEventListener('change', function() {
        if (this.value === 'custom') {
          // Replace dropdown with text input for custom dosage
          const customInput = document.createElement('input');
          customInput.type = 'text';
          customInput.id = 'medDosage';
          customInput.placeholder = 'e.g., 25mg';
          customInput.oninput = checkDosageRealtime;
          customInput.style.cssText = this.style.cssText;
          this.parentElement.replaceChild(customInput, this);
          customInput.focus();
        } else {
          checkDosageRealtime();
        }
      });
      
      // Replace input with dropdown
      dosageInput.parentElement.replaceChild(dosageDropdown, dosageInput);
      
      console.log('‚úì Dosage dropdown populated with', medication.dosages.length, 'options');
    }
    
    // Display medication information from local database
    function displayMedicationInfo(medication) {
      const infoBox = document.getElementById('medInfoBox');
      
      const infoHtml = `
        <div style="padding:0.75rem;background:var(--bg-subtle);border-radius:var(--radius-sm);margin-top:0.5rem">
          <div style="font-size:0.8125rem;color:var(--text);margin-bottom:0.5rem">
            <strong>${medication.name}</strong> ${medication.genericName ? `(${medication.genericName})` : ''}
          </div>
          ${medication.brandNames && medication.brandNames.length > 0 ? `
            <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem">
              <strong>Brand Names:</strong> ${medication.brandNames.join(', ')}
            </div>
          ` : ''}
          ${medication.category ? `
            <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem">
              <strong>Category:</strong> ${medication.category}
            </div>
          ` : ''}
          ${medication.frequency ? `
            <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem">
              <strong>Frequency:</strong> ${medication.frequency}
            </div>
          ` : ''}
          ${medication.maxDailyDose ? `
            <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem">
              <strong>Max Daily Dose:</strong> ${medication.maxDailyDose}
            </div>
          ` : ''}
          ${medication.pregnancyCategory ? `
            <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem">
              <strong>Pregnancy Category:</strong> ${medication.pregnancyCategory}
            </div>
          ` : ''}
          ${medication.lactationSafety ? `
            <div style="font-size:0.75rem;color:var(--text-secondary)">
              <strong>Lactation Safety:</strong> ${medication.lactationSafety}
            </div>
          ` : ''}
        </div>
      `;
      
      infoBox.innerHTML = infoHtml;
    }
    
    function selectMedicationFromData(element) {
      const candidate = element.getAttribute('data-candidate');
      const rxcui = element.getAttribute('data-rxcui');
      if (candidate && rxcui) {
        selectMedication(candidate, parseInt(rxcui, 10));
      }
    }
    
    async function selectMedication(name, rxcui) {
      document.getElementById('medName').value = name;
      document.getElementById('medSearchResults').style.display = 'none';
      // Store RxCUI in a hidden field for later use
      document.getElementById('medName').setAttribute('data-rxcui', rxcui);
      await fetchDrugInformation(rxcui, name);
    }
    
    async function fetchDrugInformation(rxcui, drugName) {
      const infoBox = document.getElementById('medInfoBox');
      infoBox.innerHTML = '<div style="color:var(--primary);font-size:0.75rem">‚è≥ Loading drug information from FDA...</div>';
      try {
        // Get drug properties from RxNorm
        const propsUrl = `https://rxnav.nlm.nih.gov/REST/rxcui/${rxcui}/properties.json`;
        const propsResponse = await fetch(propsUrl);
        if (!propsResponse.ok) throw new Error('RxNorm properties failed');
        const propsData = await propsResponse.json();
        const drugInfo = propsData.properties;
        // Try to get FDA label data
        let fdaWarnings = [];
        try {
          const fdaUrl = `https://api.fda.gov/drug/label.json?search=openfda.brand_name:"${encodeURIComponent(drugName)}"&limit=1`;
          const fdaResponse = await fetch(fdaUrl);
          if (fdaResponse.ok) {
            const fdaData = await fdaResponse.json();
            if (fdaData.results && fdaData.results[0]) {
              const label = fdaData.results[0];
              if (label.warnings) {
                fdaWarnings = label.warnings.slice(0, 3);
              }
              if (label.boxed_warning) {
                fdaWarnings.unshift('‚ö†Ô∏è BLACK BOX WARNING: ' + label.boxed_warning[0].substring(0, 200) + '...');
              }
            }
          }
        } catch (fdaError) {
          fdaWarnings.push('‚ö†Ô∏è FDA data not available for this drug.');
        }
        let html = '<div style="background:var(--bg-subtle);padding:0.75rem;border-radius:var(--radius-sm);border-left:3px solid var(--primary)">';
        html += `<div style="font-weight:700;color:var(--primary);margin-bottom:0.5rem">‚úì ${drugInfo.name}</div>`;
        if (drugInfo.synonym) {
          html += `<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.375rem">Also known as: ${drugInfo.synonym}</div>`;
        }
        if (fdaWarnings.length > 0) {
          html += '<div style="margin-top:0.625rem;padding-top:0.625rem;border-top:1px solid var(--border)">';
          html += '<div style="font-weight:600;font-size:0.8125rem;color:#ef4444;margin-bottom:0.375rem">‚ö†Ô∏è FDA Warnings:</div>';
          fdaWarnings.forEach(w => {
            const warningText = typeof w === 'string' ? w : w[0];
            const truncated = warningText.substring(0, 150) + (warningText.length > 150 ? '...' : '');
            html += `<div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.25rem">‚Ä¢ ${truncated}</div>`;
          });
          html += '</div>';
        }
        html += '<div style="margin-top:0.625rem;font-size:0.6875rem;color:var(--text-muted)">Source: NIH RxNorm + FDA OpenFDA</div>';
        html += '</div>';
        infoBox.innerHTML = html;
        MED_CACHE.fda[rxcui] = { drugInfo, fdaWarnings };
      } catch (error) {
        console.error('Error fetching drug information:', error);
        infoBox.innerHTML = '<div style="color:#ef4444;font-size:0.75rem">‚ö†Ô∏è Could not fetch official drug data. Please verify dosage with your doctor.</div>';
      }
    }
    
    // Check for drug interactions using RxNorm API
      async function checkDrugInteractions(medicationList) {
        // Only check for medications (not supplements)
        const medsWithRxcui = medicationList.filter(m => m.type === 'medication' && m.rxcui);
        if (medsWithRxcui.length < 2) return [];

        const rxcuis = medsWithRxcui.map(m => m.rxcui).join('+');
        try {
          const url = `https://rxnav.nlm.nih.gov/REST/interaction/list.json?rxcuis=${rxcuis}`;
          const response = await fetch(url);
          if (!response.ok) throw new Error('RxNorm interaction API failed');
          const data = await response.json();
          const interactions = [];
          const groups = data.fullInteractionTypeGroup || [];
          groups.forEach(group => {
            (group.fullInteractionType || []).forEach(type => {
              (type.interactionPair || []).forEach(pair => {
                interactions.push({
                  description: pair.description,
                  severity: pair.severity || 'N/A',
                  source: pair.sourceName || 'RxNorm'
                });
              });
            });
          });
          return interactions;
        } catch (error) {
          console.error('Interaction check error:', error);
          return [];
        }
      }

      // UI: Check and display drug interactions
      async function checkInteractions() {
        const definitions = DB.get('medicationDefinitions');
        // Only check for medications with RxCUI
        const interactions = await checkDrugInteractions(definitions);
        const container = document.getElementById('interactionWarnings');
        if (!container) return;
        if (!interactions || interactions.length === 0) {
          container.innerHTML = '<div class="insight positive">‚úÖ No dangerous interactions detected.</div>';
          return;
        }
        container.innerHTML = interactions.map(i =>
          `<div class="insight warning"><strong>‚ö†Ô∏è Drug Interaction:</strong> ${i.description} <span style="color:#ef4444;font-weight:600">[${i.severity}]</span></div>`
        ).join('');
      }

    // Load and display mood history
    function loadMoodHistory() {
      const moods = DB.get('moods');
      const container = document.getElementById('moodHistory');
      if (moods.length === 0) {
        container.innerHTML = '<div class="insight">No mood entries yet. Start tracking!</div>';
        return;
      }
      container.innerHTML = moods.slice(0, 10).map(m => `
        <div class="data-item">
          <div class="data-item-info">
            <div class="data-item-title">${moodEmojis[m.mood - 1]} Mood: ${m.mood}/10</div>
            <div class="data-item-meta">${new Date(m.date).toLocaleDateString()} ${m.symptoms.length ? '‚Ä¢ ' + m.symptoms.join(', ') : ''}</div>
            ${m.notes ? `<div style="margin-top:0.5rem;color:var(--muted);font-size:0.875rem">${m.notes}</div>` : ''}
          </div>
          <div class="entry-actions">
            <button class="edit-btn" onclick="openEditModal('mood', '${m.date}')" aria-label="Edit mood entry" title="Edit">
              ‚úèÔ∏è Edit
            </button>
            <button class="delete-btn" onclick="deleteMoodEntry('${m.date}')" aria-label="Delete mood entry" title="Delete">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // ============================================
    // DOSAGE VALIDATION FUNCTIONS
    // ============================================
    
    function parseDosage(dosageStr) {
      // Extract number and unit from dosage string
      const match = dosageStr.match(/(\d+(?:\.\d+)?)\s*(mg|mcg|¬µg|g|iu|ml)?/i);
      if (!match) return null;
      
      let amount = parseFloat(match[1]);
      let unit = (match[2] || 'mg').toLowerCase();
      
      // Normalize unit names
      if (unit === '¬µg') unit = 'mcg';
      
      return { amount, unit, originalUnit: unit };
    }
    
    function validateDosage(medName, dosageStr) {
      const parsed = parseDosage(dosageStr);
      if (!parsed) return { valid: true }; // If can't parse, allow it (custom dosage)
      
      const medLower = medName.toLowerCase();
      const warnings = [];
      let foundMatch = false;
      
      // UNIVERSAL SAFETY CHECK - Flag obviously dangerous dosages for ANY medication
      let { amount, unit } = parsed;
      let amountInMg = amount;
      
      // Convert everything to mg for universal check
      if (unit === 'g') amountInMg = amount * 1000;
      if (unit === 'mcg') amountInMg = amount / 1000;
      if (unit === 'iu') amountInMg = amount; // Treat IU as comparable to mg for safety
      
      // Universal thresholds (very conservative)
      if (amountInMg > 50000) { // More than 50 grams is extremely dangerous
        warnings.push({
          level: 'critical',
          message: `üÜò CRITICAL: Dosage of ${dosageStr} is EXTREMELY HIGH and potentially LETHAL! A typical medication dose is under 2000mg. Do NOT take this amount. If already taken, contact poison control immediately: 1-800-222-1222`
        });
        return { valid: false, warnings };
      }
      
      if (amountInMg > 10000) { // More than 10 grams
        warnings.push({
          level: 'danger',
          message: `üö® WARNING: Dosage of ${dosageStr} is VERY HIGH (${Math.round(amountInMg)}mg). Most medications are dosed between 1-2000mg. This could be dangerous. Verify with your doctor before taking.`
        });
      }
      
      // Better medication name matching with word boundaries
      const aliases = {
        'd3': 'vitamin d',
        'd': 'vitamin d',
        'vit d': 'vitamin d',
        'b12': 'vitamin b12',  // Exact match for b12 first
        'b-12': 'vitamin b12',
        'vit b12': 'vitamin b12',
        'b1': 'vitamin b1',   // b1 comes after b12
        'b2': 'vitamin b2',
        'b3': 'vitamin b3',
        'b6': 'vitamin b6',
        'b9': 'vitamin b9',
        'vit c': 'vitamin c',
        'c': 'vitamin c',
        'k2': 'vitamin k',
        'k': 'vitamin k'
      };
      
      let searchName = medLower;
      // Use exact match or whole-word match to prevent "b12" from matching "b1"
      for (const [alias, canonical] of Object.entries(aliases)) {
        // Exact match (e.g., "b12" === "b12")
        if (medLower === alias) {
          searchName = canonical;
          break;
        }
        // Word boundary match (e.g., "vit b12" contains " b12 " as a word)
        const wordRegex = new RegExp(`\\b${alias}\\b`, 'i');
        if (wordRegex.test(medLower)) {
          searchName = canonical;
          break;
        }
      }
      
      // Check against known safe ranges
      // CRITICAL: Use word-boundary matching to prevent "vitamin b12" from matching "vitamin b1"
      for (const [drug, range] of Object.entries(dosageRanges)) {
        // Method 1: Exact match
        let isMatch = searchName === drug;
        
        // Method 2: Word boundary match (e.g., "vitamin b12 supplement" contains "vitamin b12" as whole words)
        if (!isMatch) {
          const drugRegex = new RegExp(`\\b${drug.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
          isMatch = drugRegex.test(searchName);
        }
        
        if (isMatch) {
          foundMatch = true;
          
          // Convert user's amount to the expected unit for this drug
          let checkAmount = amount;
          
          // User entered in mg, drug expects mcg
          if (unit === 'mg' && range.unit === 'mcg') {
            checkAmount = amount * 1000; // Convert mg to mcg
          }
          // User entered in mcg, drug expects mg  
          else if (unit === 'mcg' && range.unit === 'mg') {
            checkAmount = amount / 1000; // Convert mcg to mg
          }
          // User entered in g, drug expects mg
          else if (unit === 'g' && range.unit === 'mg') {
            checkAmount = amount * 1000; // Convert g to mg
          }
          // User entered in mg, drug expects IU (can't convert, compare as-is)
          else if (unit === 'mg' && range.unit === 'IU') {
            // Can't reliably convert, use warning
            warnings.push({
              level: 'info',
              message: `‚ö†Ô∏è ${range.name} is typically measured in ${range.unit}, not ${unit}. Please verify dosage with your doctor.`
            });
            break;
          }
          // User entered in IU, drug expects mg (can't convert)
          else if (unit === 'iu' && range.unit === 'mg') {
            warnings.push({
              level: 'info',
              message: `‚ö†Ô∏è ${range.name} is typically measured in ${range.unit}, not IU. Please verify dosage with your doctor.`
            });
            break;
          }
          
          if (checkAmount < range.min) {
            warnings.push({
              level: 'info',
              message: `üíä ${range.name}: Dosage (${dosageStr}) is below typical range (${range.min}-${range.max} ${range.unit}). Consult your doctor if prescribed.`
            });
          }
          
          if (checkAmount > range.max && checkAmount <= range.max * 5) {
            warnings.push({
              level: 'danger',
              message: `üö® DANGER: ${range.name} dosage (${dosageStr}) EXCEEDS safe limit of ${range.max} ${range.unit}! This could be harmful. Please verify with your doctor immediately.`
            });
          }
          
          if (checkAmount > range.max * 5) {
            warnings.push({
              level: 'critical',
              message: `üÜò CRITICAL: ${range.name} dosage (${dosageStr}) is ${Math.round(checkAmount/range.max)}x the maximum safe dose! This is potentially LIFE-THREATENING. Do NOT take this amount. Contact poison control if already taken: 1-800-222-1222`
            });
            return { valid: false, warnings };
          }
          
          break; // Found matching drug
        }
      }
      
      return { valid: warnings.every(w => w.level !== 'critical'), warnings, foundMatch };
    }

    // ============================================
    // MEDICATION SYSTEM (NEW - PERSISTENT DAILY LOGS)
    // ============================================
    
    // Helper function: Convert time preset to HH:MM format
    function normalizeTimeValue(timeInput) {
      // If already in HH:MM format (contains colon), return as-is
      if (timeInput && timeInput.includes(':')) {
        return timeInput;
      }
      
      // Convert text presets to default times
      const presetTimes = {
        'morning': '08:00',
        'afternoon': '12:00',
        'evening': '18:00',
        'night': '20:00'
      };
      
      const normalized = presetTimes[timeInput.toLowerCase()];
      if (normalized) {
        return normalized;
      }
      
      // Fallback: return default morning time
      console.warn(`Unknown time value: "${timeInput}". Using default 09:00`);
      return '09:00';
    }
    
    // Helper function: Validate time string is in HH:MM format
    function isValidTimeFormat(timeStr) {
      if (!timeStr) return false;
      const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
      return timeRegex.test(timeStr);
    }
    
    // Migrate old medications data on first load
    function migrateMedicationsToDefinitions() {
      // Check if migration already done
      if (DB.getOne('medicationsMigrated')) return;
      
      const oldMeds = DB.get('medications');
      if (oldMeds.length > 0) {
        // Convert old format to medicationDefinitions
        const definitions = oldMeds.map(m => ({
          id: m.id || Date.now() + Math.random(),
          name: m.name,
          dosage: m.dosage,
          scheduledTimes: [m.time || '9:00'], // Default time if missing
          asNeeded: false
        }));
        DB.set('medicationDefinitions', definitions);
        
        // Clear old medications array
        DB.set('medications', []);
        DB.setOne('medicationsMigrated', true);
        console.log('Migrated', definitions.length, 'medications to new system');
      } else {
        DB.setOne('medicationsMigrated', true);
      }
    }

    // Generate today's pending doses from medication definitions
    function generateTodaysDoses() {
      const definitions = DB.get('medicationDefinitions');
      const logs = DB.get('medicationLogs');
      const today = new Date().toDateString();
      
      definitions.forEach(def => {
        // For each scheduled time, check if log already exists for today
        def.scheduledTimes.forEach(scheduledTime => {
          // CRITICAL: Normalize time value before parsing
          const normalizedTime = normalizeTimeValue(scheduledTime);
          
          // Validate time format
          if (!isValidTimeFormat(normalizedTime)) {
            console.error(`Invalid time format for medication "${def.name}": ${scheduledTime} ‚Üí ${normalizedTime}`);
            return; // Skip this dose
          }
          
          const existingLog = logs.find(log => 
            log.medId === def.id && 
            new Date(log.scheduledFor).toDateString() === today &&
            log.scheduledTime === normalizedTime
          );
          
          if (!existingLog) {
            // Create pending dose for today
            const scheduledDate = new Date();
            const [hours, minutes] = normalizedTime.split(':');
            scheduledDate.setHours(parseInt(hours), parseInt(minutes || 0), 0, 0);
            
            logs.push({
              id: Date.now() + Math.random(),
              medId: def.id,
              medName: def.name,
              dosage: def.dosage,
              scheduledFor: scheduledDate.toISOString(),
              scheduledTime: normalizedTime,
              status: 'pending', // pending, taken, missed, late
              takenAt: null
            });
          }
        });
      });
      
      DB.set('medicationLogs', logs);
    }

    // Toggle pregnancy fields visibility
    function togglePregnancyFields() {
      const isChecked = document.getElementById('isPregnant').checked;
      const fieldsDiv = document.getElementById('pregnancyFields');
      fieldsDiv.style.display = isChecked ? 'block' : 'none';
      
      if (!isChecked) {
        document.getElementById('pregnancyWarning').style.display = 'none';
      }
    }

    // Add new medication definition
    function addMedication() {
      const type = document.getElementById('medType').value; // medication or supplement
      const nameInput = document.getElementById('medName');
      const name = nameInput.value.trim();
      const rxcui = nameInput.getAttribute('data-rxcui') || null;
      const dosage = document.getElementById('medDosage').value.trim();
      const time = document.getElementById('medTime').value;
      
      if (!name) return alert('Please enter medication/supplement name');
      
      // CRITICAL: Normalize time value before storing
      const normalizedTime = normalizeTimeValue(time);
      
      // Validate time format
      if (!isValidTimeFormat(normalizedTime)) {
        return alert(`Invalid time format: "${time}". Please select a valid time.`);
      }

      // CRITICAL: Different validation for medications vs supplements
      if (type === 'medication') {
        // Validate dosage safety for medications (stricter)
        const validation = validateDosage(name, dosage);
        
        if (validation.warnings && validation.warnings.length > 0) {
          let warningMsg = '‚ö†Ô∏è MEDICATION SAFETY WARNINGS:\n\n';
          validation.warnings.forEach(w => {
            warningMsg += w.message + '\n\n';
          });
          
          if (!validation.valid) {
            warningMsg += '\n‚ùå This medication was NOT saved due to dangerous dosage.\n\n';
            warningMsg += 'üè• REQUIRED ACTIONS:\n';
            warningMsg += '1. Verify dosage with your healthcare provider\n';
            warningMsg += '2. If you believe this is an error, contact us\n';
            warningMsg += '3. In case of overdose, call Poison Control: 1-800-222-1222';
            alert(warningMsg);
            return;
          } else {
            warningMsg += '\n\n‚ö†Ô∏è Do you want to save this medication anyway?\n';
            warningMsg += '(Only proceed if prescribed by your healthcare provider)';
            if (!confirm(warningMsg)) {
              return;
            }
          }
        }
      } else {
        // For supplements, show informational warning only
        const validation = validateDosage(name, dosage);
        if (validation.warnings && validation.warnings.some(w => w.level === 'danger' || w.level === 'critical')) {
          let warningMsg = '‚ö†Ô∏è SUPPLEMENT DOSAGE NOTICE:\n\n';
          validation.warnings.forEach(w => {
            if (w.level === 'danger' || w.level === 'critical') {
              warningMsg += w.message + '\n\n';
            }
          });
          warningMsg += '\nüåø Supplements can have side effects at high doses.\n';
          warningMsg += 'Consult a healthcare provider before taking high-dose supplements.\n\n';
          warningMsg += 'Continue adding this supplement?';
          
          if (!confirm(warningMsg)) {
            return;
          }
        }
      }

      // PREGNANCY SAFETY CHECK
      const isPregnant = document.getElementById('isPregnant').checked;
      if (isPregnant && type === 'medication') {
        const pregnancyWeek = parseInt(document.getElementById('pregnancyWeek').value);
        const patientId = document.getElementById('pregnancyPatientId').value.trim();
        
        if (!pregnancyWeek || pregnancyWeek < 1 || pregnancyWeek > 42) {
          alert('‚ö†Ô∏è Please enter a valid pregnancy week (1-42) to check medication safety.');
          return;
        }
        
        // Show checking message
        const warningDiv = document.getElementById('pregnancyWarning');
        const warningContent = document.getElementById('pregnancyWarningContent');
        warningDiv.style.display = 'block';
        warningContent.innerHTML = '‚è≥ Checking pregnancy safety...';
        
        // Check pregnancy safety (this would call the backend in production)
        fetch('/api/check-pregnancy-safety', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            medicationName: name,
            weekOfPregnancy: pregnancyWeek,
            patientId: patientId || null
          })
        })
        .then(res => res.json())
        .then(safetyResult => {
          if (!safetyResult.safe) {
            // Show detailed warning
            let warningHTML = `
              <div style="margin-bottom:0.5rem">
                <strong>FDA Category ${safetyResult.fdaCategory || 'Unknown'}</strong> - ${safetyResult.riskLevel || 'Unknown Risk'}
              </div>
              <div style="margin-bottom:0.5rem">${safetyResult.recommendation}</div>
            `;
            
            if (safetyResult.warnings && safetyResult.warnings.length > 0) {
              warningHTML += '<div style="margin-top:0.5rem"><strong>Warnings:</strong><ul style="margin:0.25rem 0;padding-left:1.5rem">';
              safetyResult.warnings.forEach(w => {
                warningHTML += `<li>${w}</li>`;
              });
              warningHTML += '</ul></div>';
            }
            
            if (safetyResult.alternatives && safetyResult.alternatives.length > 0) {
              warningHTML += '<div style="margin-top:0.5rem"><strong>Safer Alternatives:</strong><ul style="margin:0.25rem 0;padding-left:1.5rem">';
              safetyResult.alternatives.forEach(alt => {
                warningHTML += `<li>${alt}</li>`;
              });
              warningHTML += '</ul></div>';
            }
            
            warningHTML += '<div style="margin-top:0.75rem;padding:0.5rem;background:#ffe5e5;border-radius:4px"><strong>‚öïÔ∏è REQUIRED: Consult your obstetrician or healthcare provider before taking this medication during pregnancy.</strong></div>';
            
            warningContent.innerHTML = warningHTML;
            
            // Ask user if they want to proceed anyway
            if (!confirm('‚ö†Ô∏è PREGNANCY SAFETY WARNING\n\n' + safetyResult.recommendation + '\n\nThis medication may not be safe during pregnancy.\n\nDo you want to add it anyway?\n(Only proceed if explicitly prescribed by your healthcare provider)')) {
              return;
            }
          } else {
            // Medication is safe
            warningContent.innerHTML = `
              <div style="color:#00b894">
                <strong>‚úÖ Generally Safe During Pregnancy</strong><br>
                FDA Category ${safetyResult.fdaCategory || 'B'} - Week ${pregnancyWeek} (Trimester ${safetyResult.trimester})<br>
                ${safetyResult.recommendation}
              </div>
            `;
          }
          
          // Continue with adding medication
          proceedWithAddingMedication();
        })
        .catch(error => {
          console.error('Pregnancy safety check error:', error);
          warningContent.innerHTML = `
            <div style="color:#d63031">
              ‚ö†Ô∏è Unable to verify pregnancy safety. Please consult your healthcare provider before taking this medication.
            </div>
          `;
          
          if (!confirm('Unable to verify pregnancy safety for this medication.\n\nConsult your healthcare provider before taking this medication during pregnancy.\n\nDo you want to add it anyway?')) {
            return;
          }
          proceedWithAddingMedication();
        });
        
        return; // Exit here, will continue in callback
      }
      
      // If not pregnant or is a supplement, proceed normally
      proceedWithAddingMedication();
      
      function proceedWithAddingMedication() {

      // Add to medication definitions
      const definitions = DB.get('medicationDefinitions');
      definitions.push({ 
        id: Date.now(), 
        name, 
        dosage, 
        type: type, // 'medication' or 'supplement'
        scheduledTimes: [normalizedTime], // Store normalized HH:MM format
        asNeeded: false,
        rxcui: rxcui // Store RxCUI if available
      });
      DB.set('medicationDefinitions', definitions);
      
      // Clear form
      nameInput.value = '';
      nameInput.removeAttribute('data-rxcui');
      document.getElementById('medDosage').value = '';
      document.getElementById('medInfoBox').innerHTML = '';
      
      // Clear pregnancy fields
      if (document.getElementById('isPregnant').checked) {
        document.getElementById('pregnancyWarning').style.display = 'none';
      }
      
      // Generate today's dose for this new medication
      generateTodaysDoses();
      loadMedications();
      loadSupplements();
      checkInteractions();
      }
    }

    // Load and display today's medication doses
    function loadMedications() {
      generateTodaysDoses(); // Ensure today's doses exist
      const logs = DB.get('medicationLogs');
      const today = new Date().toDateString();
      // Only show medications (not supplements)
      const definitions = DB.get('medicationDefinitions');
      const medIds = definitions.filter(d => d.type === 'medication').map(d => d.id);
      const todaysLogs = logs.filter(log => 
        new Date(log.scheduledFor).toDateString() === today && medIds.includes(log.medId)
      ).sort((a, b) => new Date(a.scheduledFor) - new Date(b.scheduledFor));
      const container = document.getElementById('medList');
      if (todaysLogs.length === 0) {
        container.innerHTML = '<div class="insight">No medications scheduled for today. Add a medication above to get started!</div>';
        return;
      }
      container.innerHTML = todaysLogs.map(log => {
        const statusClass = log.status === 'taken' ? 'taken' : log.status === 'missed' ? 'missed' : '';
        const statusIcon = log.status === 'taken' ? '‚úÖ' : log.status === 'missed' ? '‚ùå' : log.status === 'late' ? '‚è∞' : '‚¨ú';
        const statusText = log.status === 'taken' ? 'Taken' : log.status === 'missed' ? 'Missed' : log.status === 'late' ? 'Taken Late' : 'Mark Taken';
        return `
          <div class="med-card ${statusClass}">
            <div class="med-name">${log.medName}</div>
            <div class="med-time">${log.dosage} ‚Ä¢ ${log.scheduledTime}</div>
            <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap">
              ${log.status === 'pending' ? `
                <button class="btn btn-success" onclick="markMedTaken(${log.id})" style="flex:1">
                  ‚úÖ Take Now
                </button>
                <button class="btn btn-secondary" onclick="markMedMissed(${log.id})" style="flex:1">
                  ‚ùå Missed
                </button>
              ` : `
                <button class="btn btn-secondary" onclick="markMedPending(${log.id})" style="flex:1">
                  ${statusIcon} ${statusText} - Undo
                </button>
              `}
              <button class="btn btn-danger" onclick="deleteMedLog(${log.id})" title="Delete this dose">
                üóëÔ∏è
              </button>
            </div>
          </div>
        `;
      }).join('');
      updateDashboard();
    }

    // Load and display supplements
    function loadSupplements() {
      const definitions = DB.get('medicationDefinitions');
      const supplements = definitions.filter(d => d.type === 'supplement');
      const container = document.getElementById('supplementList');
      if (!container) return;
      if (supplements.length === 0) {
        container.innerHTML = '<div class="insight">No supplements tracked. Add a supplement above.</div>';
        return;
      }
      container.innerHTML = supplements.map(sup => `
        <div class="med-card">
          <div class="med-name">${sup.name}</div>
          <div class="med-time">${sup.dosage} ‚Ä¢ ${sup.scheduledTimes[0]}</div>
          <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap">
            <button class="btn btn-danger" onclick="deleteSupplement(${sup.id})" title="Delete this supplement">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function deleteSupplement(id) {
      let definitions = DB.get('medicationDefinitions');
      definitions = definitions.filter(d => d.id !== id);
      DB.set('medicationDefinitions', definitions);
      loadSupplements();
      loadMedications();
      checkInteractions();
    }

    // Mark medication as taken
    function markMedTaken(logId) {
      const logs = DB.get('medicationLogs');
      const log = logs.find(l => l.id === logId);
      if (log) {
        const now = new Date();
        const scheduled = new Date(log.scheduledFor);
        const minutesLate = (now - scheduled) / (1000 * 60);
        
        log.status = minutesLate > 30 ? 'late' : 'taken';
        log.takenAt = now.toISOString();
        
        DB.set('medicationLogs', logs);
        loadMedications();
      }
    }

    // Mark medication as missed
    function markMedMissed(logId) {
      const logs = DB.get('medicationLogs');
      const log = logs.find(l => l.id === logId);
      if (log) {
        log.status = 'missed';
        log.takenAt = null;
        DB.set('medicationLogs', logs);
        loadMedications();
      }
    }

    // Mark back to pending (undo)
    function markMedPending(logId) {
      const logs = DB.get('medicationLogs');
      const log = logs.find(l => l.id === logId);
      if (log) {
        log.status = 'pending';
        log.takenAt = null;
        DB.set('medicationLogs', logs);
        loadMedications();
      }
    }

    // Delete a specific dose log
    function deleteMedLog(logId) {
      if (!confirm('Delete this dose? This will remove it from your history.')) return;
      const logs = DB.get('medicationLogs').filter(l => l.id !== logId);
      DB.set('medicationLogs', logs);
      loadMedications();
    }

    // Delete medication definition (removes all future doses)
    function deleteMedDefinition(defId) {
      if (!confirm('Delete this medication entirely? This will remove all scheduled doses.')) return;
      const definitions = DB.get('medicationDefinitions').filter(d => d.id !== defId);
      DB.set('medicationDefinitions', definitions);
      
      // Also remove future logs for this medication
      const logs = DB.get('medicationLogs').filter(l => l.medId !== defId);
      DB.set('medicationLogs', logs);
      
      loadMedications();
      checkInteractions();
    }

    // ============================================
    // MEDICATION SAFETY DATABASE
    // ============================================
    
    // Safe dosage ranges (in mg unless specified)
    const dosageRanges = {
      // ===== FAT-SOLUBLE VITAMINS (A, D, E, K) =====
      'vitamin a': { min: 700, max: 3000, unit: 'mcg', name: 'Vitamin A' },
      'retinol': { min: 700, max: 3000, unit: 'mcg', name: 'Vitamin A (Retinol)' },
      'beta carotene': { min: 3, max: 20, unit: 'mg', name: 'Beta-Carotene' },
      'vitamin d': { min: 400, max: 4000, unit: 'IU', name: 'Vitamin D' },
      'vitamin d3': { min: 400, max: 4000, unit: 'IU', name: 'Vitamin D3' },
      'cholecalciferol': { min: 400, max: 4000, unit: 'IU', name: 'Vitamin D3 (Cholecalciferol)' },
      'vitamin e': { min: 15, max: 1000, unit: 'mg', name: 'Vitamin E' },
      'tocopherol': { min: 15, max: 1000, unit: 'mg', name: 'Vitamin E (Tocopherol)' },
      'vitamin k': { min: 90, max: 120, unit: 'mcg', name: 'Vitamin K' },
      'vitamin k1': { min: 90, max: 120, unit: 'mcg', name: 'Vitamin K1 (Phylloquinone)' },
      'vitamin k2': { min: 90, max: 200, unit: 'mcg', name: 'Vitamin K2 (Menaquinone)' },
      
      // ===== WATER-SOLUBLE VITAMINS (B-complex, C) =====
      'vitamin c': { min: 65, max: 2000, unit: 'mg', name: 'Vitamin C' },
      'ascorbic acid': { min: 65, max: 2000, unit: 'mg', name: 'Vitamin C (Ascorbic Acid)' },
      'vitamin b1': { min: 1.1, max: 100, unit: 'mg', name: 'Vitamin B1 (Thiamine)' },
      'thiamine': { min: 1.1, max: 100, unit: 'mg', name: 'Thiamine (Vitamin B1)' },
      'vitamin b2': { min: 1.1, max: 100, unit: 'mg', name: 'Vitamin B2 (Riboflavin)' },
      'riboflavin': { min: 1.1, max: 100, unit: 'mg', name: 'Riboflavin (Vitamin B2)' },
      'vitamin b3': { min: 14, max: 35, unit: 'mg', name: 'Vitamin B3 (Niacin)' },
      'niacin': { min: 14, max: 35, unit: 'mg', name: 'Niacin (Vitamin B3)' },
      'vitamin b5': { min: 5, max: 1000, unit: 'mg', name: 'Vitamin B5 (Pantothenic Acid)' },
      'pantothenic acid': { min: 5, max: 1000, unit: 'mg', name: 'Pantothenic Acid (Vitamin B5)' },
      'vitamin b6': { min: 1.3, max: 100, unit: 'mg', name: 'Vitamin B6 (Pyridoxine)' },
      'pyridoxine': { min: 1.3, max: 100, unit: 'mg', name: 'Pyridoxine (Vitamin B6)' },
      'vitamin b7': { min: 30, max: 10000, unit: 'mcg', name: 'Vitamin B7 (Biotin)' },
      'biotin': { min: 30, max: 10000, unit: 'mcg', name: 'Biotin (Vitamin B7)' },
      'vitamin b9': { min: 400, max: 1000, unit: 'mcg', name: 'Vitamin B9 (Folate)' },
      'folate': { min: 400, max: 1000, unit: 'mcg', name: 'Folate (Vitamin B9)' },
      'folic acid': { min: 400, max: 1000, unit: 'mcg', name: 'Folic Acid (Vitamin B9)' },
      'vitamin b12': { min: 2.4, max: 1000, unit: 'mcg', name: 'Vitamin B12' },
      'cobalamin': { min: 2.4, max: 1000, unit: 'mcg', name: 'Cobalamin (Vitamin B12)' },
      'methylcobalamin': { min: 2.4, max: 1000, unit: 'mcg', name: 'Methylcobalamin (B12)' },
      
      // ===== MINERALS =====
      'calcium': { min: 1000, max: 2500, unit: 'mg', name: 'Calcium' },
      'calcium citrate': { min: 1000, max: 2500, unit: 'mg', name: 'Calcium Citrate' },
      'calcium carbonate': { min: 1000, max: 2500, unit: 'mg', name: 'Calcium Carbonate' },
      'iron': { min: 8, max: 45, unit: 'mg', name: 'Iron' },
      'ferrous sulfate': { min: 8, max: 45, unit: 'mg', name: 'Ferrous Sulfate (Iron)' },
      'magnesium': { min: 310, max: 420, unit: 'mg', name: 'Magnesium' },
      'magnesium citrate': { min: 310, max: 420, unit: 'mg', name: 'Magnesium Citrate' },
      'magnesium glycinate': { min: 310, max: 420, unit: 'mg', name: 'Magnesium Glycinate' },
      'zinc': { min: 8, max: 40, unit: 'mg', name: 'Zinc' },
      'zinc picolinate': { min: 8, max: 40, unit: 'mg', name: 'Zinc Picolinate' },
      'potassium': { min: 2600, max: 3400, unit: 'mg', name: 'Potassium' },
      'selenium': { min: 55, max: 400, unit: 'mcg', name: 'Selenium' },
      'copper': { min: 0.9, max: 10, unit: 'mg', name: 'Copper' },
      'chromium': { min: 25, max: 200, unit: 'mcg', name: 'Chromium' },
      'iodine': { min: 150, max: 1100, unit: 'mcg', name: 'Iodine' },
      'manganese': { min: 1.8, max: 11, unit: 'mg', name: 'Manganese' },
      'molybdenum': { min: 45, max: 2000, unit: 'mcg', name: 'Molybdenum' },
      'phosphorus': { min: 700, max: 4000, unit: 'mg', name: 'Phosphorus' },
      
      // ===== OMEGA FATTY ACIDS & SUPPLEMENTS =====
      'fish oil': { min: 250, max: 3000, unit: 'mg', name: 'Fish Oil/Omega-3' },
      'omega 3': { min: 250, max: 3000, unit: 'mg', name: 'Omega-3' },
      'omega-3': { min: 250, max: 3000, unit: 'mg', name: 'Omega-3' },
      'epa': { min: 250, max: 2000, unit: 'mg', name: 'EPA (Omega-3)' },
      'dha': { min: 250, max: 2000, unit: 'mg', name: 'DHA (Omega-3)' },
      'coq10': { min: 30, max: 200, unit: 'mg', name: 'CoQ10 (Coenzyme Q10)' },
      'coenzyme q10': { min: 30, max: 200, unit: 'mg', name: 'Coenzyme Q10' },
      'glucosamine': { min: 500, max: 2000, unit: 'mg', name: 'Glucosamine' },
      'chondroitin': { min: 400, max: 1200, unit: 'mg', name: 'Chondroitin' },
      'turmeric': { min: 500, max: 2000, unit: 'mg', name: 'Turmeric' },
      'curcumin': { min: 500, max: 2000, unit: 'mg', name: 'Curcumin' },
      'probiotics': { min: 1, max: 100, unit: 'billion CFU', name: 'Probiotics' },
      'melatonin': { min: 0.5, max: 10, unit: 'mg', name: 'Melatonin' },
      'collagen': { min: 2500, max: 15000, unit: 'mg', name: 'Collagen' },
      'ashwagandha': { min: 300, max: 1200, unit: 'mg', name: 'Ashwagandha' },
      'rhodiola': { min: 200, max: 600, unit: 'mg', name: 'Rhodiola' },
      'ginkgo biloba': { min: 120, max: 240, unit: 'mg', name: 'Ginkgo Biloba' },
      'st john\'s wort': { min: 300, max: 900, unit: 'mg', name: 'St. John\'s Wort' },
      'valerian root': { min: 300, max: 900, unit: 'mg', name: 'Valerian Root' },
      'saw palmetto': { min: 160, max: 320, unit: 'mg', name: 'Saw Palmetto' },
      'milk thistle': { min: 140, max: 800, unit: 'mg', name: 'Milk Thistle' },
      
      // ===== PAIN RELIEVERS & FEVER REDUCERS =====
      'aspirin': { min: 81, max: 325, unit: 'mg', name: 'Aspirin' },
      'ibuprofen': { min: 200, max: 800, unit: 'mg', name: 'Ibuprofen' },
      'advil': { min: 200, max: 800, unit: 'mg', name: 'Advil (Ibuprofen)' },
      'motrin': { min: 200, max: 800, unit: 'mg', name: 'Motrin (Ibuprofen)' },
      'naproxen': { min: 220, max: 500, unit: 'mg', name: 'Naproxen' },
      'aleve': { min: 220, max: 500, unit: 'mg', name: 'Aleve (Naproxen)' },
      'acetaminophen': { min: 325, max: 1000, unit: 'mg', name: 'Acetaminophen' },
      'tylenol': { min: 325, max: 1000, unit: 'mg', name: 'Tylenol (Acetaminophen)' },
      'paracetamol': { min: 325, max: 1000, unit: 'mg', name: 'Paracetamol (Acetaminophen)' },
      
      // ===== BLOOD PRESSURE MEDICATIONS =====
      'lisinopril': { min: 2.5, max: 40, unit: 'mg', name: 'Lisinopril' },
      'amlodipine': { min: 2.5, max: 10, unit: 'mg', name: 'Amlodipine' },
      'losartan': { min: 25, max: 100, unit: 'mg', name: 'Losartan' },
      'metoprolol': { min: 25, max: 200, unit: 'mg', name: 'Metoprolol' },
      'atenolol': { min: 25, max: 100, unit: 'mg', name: 'Atenolol' },
      'hydrochlorothiazide': { min: 12.5, max: 50, unit: 'mg', name: 'Hydrochlorothiazide' },
      'hctz': { min: 12.5, max: 50, unit: 'mg', name: 'HCTZ (Hydrochlorothiazide)' },
      
      // ===== CHOLESTEROL & STATINS =====
      'atorvastatin': { min: 10, max: 80, unit: 'mg', name: 'Atorvastatin' },
      'lipitor': { min: 10, max: 80, unit: 'mg', name: 'Lipitor (Atorvastatin)' },
      'simvastatin': { min: 5, max: 40, unit: 'mg', name: 'Simvastatin' },
      'rosuvastatin': { min: 5, max: 40, unit: 'mg', name: 'Rosuvastatin' },
      'crestor': { min: 5, max: 40, unit: 'mg', name: 'Crestor (Rosuvastatin)' },
      'pravastatin': { min: 10, max: 80, unit: 'mg', name: 'Pravastatin' },
      
      // ===== DIABETES MEDICATIONS =====
      'metformin': { min: 500, max: 2000, unit: 'mg', name: 'Metformin' },
      'glucophage': { min: 500, max: 2000, unit: 'mg', name: 'Glucophage (Metformin)' },
      'glipizide': { min: 2.5, max: 20, unit: 'mg', name: 'Glipizide' },
      'glyburide': { min: 1.25, max: 20, unit: 'mg', name: 'Glyburide' },
      
      // ===== THYROID MEDICATIONS =====
      'levothyroxine': { min: 25, max: 200, unit: 'mcg', name: 'Levothyroxine' },
      'synthroid': { min: 25, max: 200, unit: 'mcg', name: 'Synthroid (Levothyroxine)' },
      'liothyronine': { min: 5, max: 25, unit: 'mcg', name: 'Liothyronine (T3)' },
      
      // ===== STOMACH/DIGESTIVE =====
      'omeprazole': { min: 20, max: 40, unit: 'mg', name: 'Omeprazole' },
      'prilosec': { min: 20, max: 40, unit: 'mg', name: 'Prilosec (Omeprazole)' },
      'esomeprazole': { min: 20, max: 40, unit: 'mg', name: 'Esomeprazole' },
      'nexium': { min: 20, max: 40, unit: 'mg', name: 'Nexium (Esomeprazole)' },
      'pantoprazole': { min: 20, max: 40, unit: 'mg', name: 'Pantoprazole' },
      'ranitidine': { min: 75, max: 300, unit: 'mg', name: 'Ranitidine' },
      'famotidine': { min: 10, max: 40, unit: 'mg', name: 'Famotidine' },
      'pepcid': { min: 10, max: 40, unit: 'mg', name: 'Pepcid (Famotidine)' },
      
      // ===== ANTIHISTAMINES & ALLERGY =====
      'cetirizine': { min: 5, max: 10, unit: 'mg', name: 'Cetirizine' },
      'zyrtec': { min: 5, max: 10, unit: 'mg', name: 'Zyrtec (Cetirizine)' },
      'loratadine': { min: 10, max: 10, unit: 'mg', name: 'Loratadine' },
      'claritin': { min: 10, max: 10, unit: 'mg', name: 'Claritin (Loratadine)' },
      'fexofenadine': { min: 60, max: 180, unit: 'mg', name: 'Fexofenadine' },
      'allegra': { min: 60, max: 180, unit: 'mg', name: 'Allegra (Fexofenadine)' },
      'diphenhydramine': { min: 25, max: 50, unit: 'mg', name: 'Diphenhydramine' },
      'benadryl': { min: 25, max: 50, unit: 'mg', name: 'Benadryl (Diphenhydramine)' },
      
      // ===== ANTIBIOTICS (COMMON) =====
      'amoxicillin': { min: 250, max: 875, unit: 'mg', name: 'Amoxicillin' },
      'azithromycin': { min: 250, max: 500, unit: 'mg', name: 'Azithromycin' },
      'z-pack': { min: 250, max: 500, unit: 'mg', name: 'Z-Pack (Azithromycin)' },
      'ciprofloxacin': { min: 250, max: 750, unit: 'mg', name: 'Ciprofloxacin' },
      'doxycycline': { min: 50, max: 200, unit: 'mg', name: 'Doxycycline' },
      'cephalexin': { min: 250, max: 500, unit: 'mg', name: 'Cephalexin' },
      
      // ===== OMEGA-3 / FISH OIL =====
      'fish oil': { min: 250, max: 3000, unit: 'mg', name: 'Fish Oil/Omega-3' },
      'omega 3': { min: 250, max: 3000, unit: 'mg', name: 'Omega-3' }
    };

    // Comprehensive drug interaction database (100+ interactions)
    const dangerousInteractions = [
      // Blood Thinners
      ['warfarin', 'aspirin', 'üö® CRITICAL: Severe bleeding risk - requires immediate medical supervision'],
      ['warfarin', 'ibuprofen', 'üö® CRITICAL: Major bleeding risk - consult doctor before combining'],
      ['warfarin', 'vitamin k', '‚ö†Ô∏è Vitamin K reduces warfarin effectiveness'],
      ['aspirin', 'ibuprofen', '‚ö†Ô∏è Both NSAIDs - increased bleeding and stomach ulcer risk'],
      ['aspirin', 'naproxen', '‚ö†Ô∏è Dual NSAID use - GI bleeding risk'],
      
      // Blood Pressure Medications
      ['lisinopril', 'potassium', 'üö® Risk of dangerous hyperkalemia (high potassium)'],
      ['lisinopril', 'ibuprofen', '‚ö†Ô∏è NSAIDs reduce ACE inhibitor effectiveness'],
      ['amlodipine', 'grapefruit', '‚ö†Ô∏è Grapefruit increases drug levels - low BP risk'],
      ['losartan', 'potassium', 'üö® Hyperkalemia risk - monitor potassium levels'],
      
      // Antidepressants (Critical)
      ['ssri', 'maoi', 'üö® CRITICAL: Life-threatening serotonin syndrome - NEVER combine'],
      ['fluoxetine', 'phenelzine', 'üö® FATAL: Serotonin syndrome - contraindicated'],
      ['sertraline', 'tramadol', 'üö® Serotonin syndrome risk - requires monitoring'],
      ['citalopram', 'triptans', '‚ö†Ô∏è Serotonin syndrome possible with migraine meds'],
      ['ssri', 'st john\'s wort', 'üö® Serotonin syndrome risk - avoid combination'],
      
      // Diabetes Medications
      ['metformin', 'alcohol', 'üö® Lactic acidosis risk - avoid alcohol'],
      ['insulin', 'alcohol', 'üö® Severe hypoglycemia (low blood sugar) risk'],
      ['glipizide', 'alcohol', 'üö® Dangerous blood sugar drops possible'],
      
      // Statins
      ['atorvastatin', 'grapefruit', '‚ö†Ô∏è Grapefruit increases statin levels - muscle damage risk'],
      ['simvastatin', 'grapefruit', 'üö® Severe muscle toxicity risk - avoid grapefruit'],
      ['lovastatin', 'clarithromycin', 'üö® Rhabdomyolysis (muscle breakdown) risk'],
      
      // Thyroid
      ['levothyroxine', 'calcium', '‚ö†Ô∏è Take 4 hours apart - calcium blocks absorption'],
      ['levothyroxine', 'iron', '‚ö†Ô∏è Take 4 hours apart - iron blocks absorption'],
      ['levothyroxine', 'antacid', '‚ö†Ô∏è Antacids reduce thyroid medication absorption'],
      
      // Antibiotics
      ['ciprofloxacin', 'antacid', '‚ö†Ô∏è Antacids block antibiotic absorption'],
      ['tetracycline', 'calcium', '‚ö†Ô∏è Dairy/calcium reduces antibiotic effectiveness'],
      ['azithromycin', 'antacid', '‚ö†Ô∏è Take azithromycin 1 hour before or 2 hours after antacids'],
      
      // Pain Medications
      ['tramadol', 'ssri', 'üö® Serotonin syndrome and seizure risk'],
      ['codeine', 'alcohol', 'üö® Severe respiratory depression - potentially fatal'],
      ['oxycodone', 'benzodiazepine', 'üö® CRITICAL: Fatal respiratory depression risk'],
      
      // Anti-anxiety/Sleep
      ['alprazolam', 'alcohol', 'üö® FATAL: Respiratory depression - never combine'],
      ['diazepam', 'opioid', 'üö® CRITICAL: Life-threatening respiratory depression'],
      ['zolpidem', 'alcohol', 'üö® Severe CNS depression - dangerous combination'],
      
      // Supplement Interactions
      ['ginkgo biloba', 'warfarin', 'üö® Increased bleeding risk'],
      ['st john\'s wort', 'birth control', '‚ö†Ô∏è Reduces contraceptive effectiveness'],
      ['vitamin e', 'warfarin', '‚ö†Ô∏è Increased bleeding risk at high doses'],
      ['fish oil', 'warfarin', '‚ö†Ô∏è May increase bleeding risk at high doses'],
      
      // Common OTC Combinations
      ['acetaminophen', 'alcohol', 'üö® Severe liver damage risk - avoid alcohol'],
      ['diphenhydramine', 'alcohol', '‚ö†Ô∏è Excessive drowsiness and impairment'],
      ['pseudoephedrine', 'maoi', 'üö® Hypertensive crisis risk']
    ];

    function checkInteractions() {
      // Use medication definitions (not individual logs) for interaction checking
      const definitions = DB.get('medicationDefinitions');
      const meds = definitions.map(d => d.name.toLowerCase());
      const warnings = [];
      dangerousInteractions.forEach(([drug1, drug2, warning]) => {
        if (meds.some(m => m.includes(drug1)) && meds.some(m => m.includes(drug2))) {
          warnings.push(warning);
        }
      });
      const container = document.getElementById('interactionWarnings');
      if (warnings.length === 0) {
        container.innerHTML = '<div class="insight positive">‚úÖ No dangerous interactions detected.</div>';
      } else {
        container.innerHTML = warnings.map(w => `<div class="insight negative">${w}</div>`).join('');
      }
    }
    
    // Real-time dosage validation as user types
    function checkDosageRealtime() {
      const name = document.getElementById('medName').value.trim();
      const dosage = document.getElementById('medDosage').value.trim();
      const warningDiv = document.getElementById('dosageWarning');
      
      if (!name || !dosage) {
        warningDiv.innerHTML = '';
        return;
      }
      
      const validation = validateDosage(name, dosage);
      
      if (validation.warnings && validation.warnings.length > 0) {
        const warning = validation.warnings[0]; // Show first/most important warning
        let color = '#3b82f6'; // blue for info
        if (warning.level === 'danger') color = '#f59e0b'; // orange
        if (warning.level === 'critical') color = '#ef4444'; // red
        
        warningDiv.innerHTML = `<div style="padding:0.5rem;background:${color}22;border-left:3px solid ${color};border-radius:4px;color:${color}">${warning.message}</div>`;
      } else {
        warningDiv.innerHTML = '<div style="color:#10b981">‚úÖ Dosage appears safe</div>';
      }
    }

    // Sleep Tracker
    function saveSleep() {
      const bedtime = document.getElementById('sleepBedtime').value;
      const wake = document.getElementById('sleepWake').value;
      const quality = parseInt(document.getElementById('sleepQuality').value);

      const bedDate = new Date(`2000-01-01T${bedtime}`);
      let wakeDate = new Date(`2000-01-01T${wake}`);
      if (wakeDate < bedDate) wakeDate.setDate(wakeDate.getDate() + 1);
      const hours = (wakeDate - bedDate) / (1000 * 60 * 60);

      const entry = { date: new Date().toISOString(), bedtime, wake, hours: Math.round(hours * 10) / 10, quality };
      const sleeps = DB.get('sleeps');
      sleeps.unshift(entry);
      DB.set('sleeps', sleeps.slice(0, 100));
      alert(`Sleep logged: ${entry.hours} hours, quality ${quality}/10`);
      loadSleepData();
      updateDashboard();
    }

    function loadSleepData() {
      const sleeps = DB.get('sleeps');
      const container = document.getElementById('sleepHistory');

      if (sleeps.length === 0) {
        container.innerHTML = '<div class="insight">No sleep data yet.</div>';
        document.getElementById('avgSleep').textContent = '--';
        document.getElementById('avgQuality').textContent = '--';
        document.getElementById('sleepDebt').textContent = '--';
        document.getElementById('sleepStreak').textContent = '--';
        return;
      }

      const avgHours = sleeps.reduce((a, s) => a + s.hours, 0) / sleeps.length;
      const avgQual = sleeps.reduce((a, s) => a + s.quality, 0) / sleeps.length;
      const debt = Math.max(0, (8 * 7) - sleeps.slice(0, 7).reduce((a, s) => a + s.hours, 0));

      document.getElementById('avgSleep').textContent = avgHours.toFixed(1);
      document.getElementById('avgQuality').textContent = avgQual.toFixed(1);
      document.getElementById('sleepDebt').textContent = debt.toFixed(1) + 'h';
      document.getElementById('sleepStreak').textContent = sleeps.length;

      container.innerHTML = sleeps.slice(0, 10).map(s => `
        <div class="data-item">
          <div class="data-item-info">
            <div class="data-item-title">${s.hours}h sleep, Quality: ${s.quality}/10</div>
            <div class="data-item-meta">${new Date(s.date).toLocaleDateString()} ‚Ä¢ ${s.bedtime} - ${s.wake}</div>
          </div>
          <div class="entry-actions">
            <button class="edit-btn" onclick="openEditModal('sleep', '${s.date}')" aria-label="Edit sleep entry" title="Edit">
              ‚úèÔ∏è Edit
            </button>
            <button class="delete-btn" onclick="deleteSleepEntry('${s.date}')" aria-label="Delete sleep entry" title="Delete">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      `).join('');
    }

    // Exercise Tracker
    function saveExercise() {
      const type = document.getElementById('exerciseType').value;
      const duration = parseInt(document.getElementById('exerciseDuration').value) || 0;
      const intensity = document.getElementById('exerciseIntensity').value;
      if (duration <= 0) return alert('Please enter duration');

      const entry = { date: new Date().toISOString(), type, duration, intensity };
      const exercises = DB.get('exercises');
      exercises.unshift(entry);
      DB.set('exercises', exercises.slice(0, 100));
      document.getElementById('exerciseDuration').value = '';
      alert(`Logged ${duration} min of ${type}! üí™`);
      loadExerciseData();
      updateDashboard();
    }

    function loadExerciseData() {
      const exercises = DB.get('exercises');
      const container = document.getElementById('exerciseHistory');
      const today = new Date().toDateString();
      const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);

      const todayMin = exercises.filter(e => new Date(e.date).toDateString() === today).reduce((a, e) => a + e.duration, 0);
      const weekMin = exercises.filter(e => new Date(e.date) > weekAgo).reduce((a, e) => a + e.duration, 0);

      document.getElementById('todayExercise').textContent = todayMin;
      document.getElementById('weekExercise').textContent = weekMin;

      if (exercises.length === 0) {
        container.innerHTML = '<div class="insight">No exercise logged yet.</div>';
        return;
      }

      const typeIcons = { walking: 'üö∂', running: 'üèÉ', cycling: 'üö¥', swimming: 'üèä', gym: 'üèãÔ∏è', yoga: 'üßò', sports: '‚öΩ', other: '‚ú®' };
      container.innerHTML = exercises.slice(0, 10).map(e => `
        <div class="data-item">
          <div class="data-item-info">
            <div class="data-item-title">${typeIcons[e.type.toLowerCase()] || 'üèÉ'} ${e.type} - ${e.duration} min</div>
            <div class="data-item-meta">${new Date(e.date).toLocaleDateString()} ‚Ä¢ ${e.intensity} intensity</div>
          </div>
          <div class="entry-actions">
            <button class="edit-btn" onclick="openEditModal('exercise', '${e.date}')" aria-label="Edit exercise entry" title="Edit">
              ‚úèÔ∏è Edit
            </button>
            <button class="delete-btn" onclick="deleteExerciseEntry('${e.date}')" aria-label="Delete exercise entry" title="Delete">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      `).join('');
    }


    // ============================================
    // CHART.JS WELLNESS TRENDS VISUALIZATION
    // ============================================
    let wellnessChart = null;

    function createWellnessTrendChart() {
      const ctx = document.getElementById('wellnessTrendChart');
      if (!ctx) return;

      const moods = DB.get('moods');
      const sleeps = DB.get('sleeps');
      const exercises = DB.get('exercises');
      const meds = DB.get('medications');

      // Get last 7 days
      const labels = [];
      const moodData = [];
      const sleepData = [];
      const exerciseData = [];
      const medicationData = [];

      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toDateString();
        
        // Label (Mon, Tue, etc.)
        labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        
        // Mood (0-10 scale)
        const dayMood = moods.find(m => new Date(m.date).toDateString() === dateStr);
        moodData.push(dayMood ? dayMood.mood : null);
        
        // Sleep (0-10 hours, normalized to 0-10 scale for chart)
        const daySleep = sleeps.find(s => new Date(s.date).toDateString() === dateStr);
        sleepData.push(daySleep ? Math.min(daySleep.hours, 10) : null);
        
        // Exercise (0-60 minutes, normalized to 0-10 scale)
        const dayExercise = exercises.filter(e => new Date(e.date).toDateString() === dateStr)
          .reduce((sum, e) => sum + e.duration, 0);
        exerciseData.push(dayExercise > 0 ? Math.min(dayExercise / 6, 10) : null);
        
        // Medication adherence (0-100% as 0-10 scale)
        const dayMedsTotal = meds.length;
        const dayMedsTaken = meds.filter(m => m.taken).length;
        medicationData.push(dayMedsTotal > 0 ? (dayMedsTaken / dayMedsTotal) * 10 : null);
      }

      // Destroy existing chart if it exists
      if (wellnessChart) {
        wellnessChart.destroy();
      }

      // Get theme colors
      const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
      const textColor = isDark ? '#f1f5f9' : '#0f172a';
      const gridColor = isDark ? '#334155' : '#e2e8f0';

      // Create new chart
      wellnessChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Mood',
              data: moodData,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Sleep (hrs)',
              data: sleepData,
              borderColor: '#8b5cf6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Exercise (min/6)',
              data: exerciseData,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Medication (%)',
              data: medicationData,
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                color: textColor,
                padding: 15,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              backgroundColor: isDark ? '#1e293b' : '#ffffff',
              titleColor: textColor,
              bodyColor: textColor,
              borderColor: gridColor,
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    if (context.dataset.label === 'Mood') {
                      label += context.parsed.y.toFixed(1) + '/10';
                    } else if (context.dataset.label === 'Sleep (hrs)') {
                      label += context.parsed.y.toFixed(1) + ' hours';
                    } else if (context.dataset.label === 'Exercise (min/6)') {
                      label += (context.parsed.y * 6).toFixed(0) + ' min';
                    } else if (context.dataset.label === 'Medication (%)') {
                      label += (context.parsed.y * 10).toFixed(0) + '%';
                    }
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
              ticks: {
                color: textColor,
                stepSize: 2
              },
              grid: {
                color: gridColor
              }
            },
            x: {
              ticks: {
                color: textColor
              },
              grid: {
                color: gridColor
              }
            }
          }
        }
      });
    }


    function updateDashboard() {
      const moods = DB.get('moods');
      const sleeps = DB.get('sleeps');
      const exercises = DB.get('exercises');
      
      // Use medication logs for today's doses (new system)
      const medLogs = DB.get('medicationLogs');
      const today = new Date().toDateString();
      const todaysMedLogs = medLogs.filter(log => 
        new Date(log.scheduledFor).toDateString() === today
      );

      const todayMood = moods.find(m => new Date(m.date).toDateString() === today);
      const todaySleep = sleeps.find(s => new Date(s.date).toDateString() === today);
      const todayExercise = exercises.filter(e => new Date(e.date).toDateString() === today).reduce((a, e) => a + e.duration, 0);
      const medsTaken = todaysMedLogs.filter(log => log.status === 'taken' || log.status === 'late').length;
      const medsTotal = todaysMedLogs.length;

      // Stats
      document.getElementById('statMood').textContent = todayMood ? todayMood.mood + '/10' : '--';
      document.getElementById('statSleep').textContent = todaySleep ? todaySleep.hours + 'h' : '--';
      document.getElementById('statExercise').textContent = todayExercise + 'min';
      document.getElementById('statMeds').textContent = medsTotal > 0 ? `${medsTaken}/${medsTotal}` : '--';

      // Calculate wellness score
      let score = 0;
      let maxScore = 0;

      if (todayMood) { score += todayMood.mood * 2.5; maxScore += 25; }
      if (todaySleep) { score += Math.min(todaySleep.hours / 8 * 25, 25); maxScore += 25; }
      if (todayExercise > 0) { score += Math.min(todayExercise / 30 * 25, 25); maxScore += 25; }
      if (medsTotal > 0) { score += (medsTaken / medsTotal) * 25; maxScore += 25; }

      const wellness = maxScore > 0 ? Math.round((score / maxScore) * 100) : 0;
      const circle = document.getElementById('wellnessCircle');
      document.getElementById('wellnessScore').textContent = wellness;
      circle.className = 'score-circle ' + (wellness >= 70 ? 'score-good' : wellness >= 40 ? 'score-medium' : 'score-low');

      // Progress bars
      const setProgress = (id, value, max) => {
        const pct = Math.min(100, (value / max) * 100);
        const element = document.getElementById(id);
        element.style.width = pct + '%';
        element.className = 'progress-fill ' + (pct >= 70 ? 'good' : pct >= 40 ? 'medium' : 'low');
        element.setAttribute('aria-valuenow', Math.round(pct));
      };

      if (moods.length > 0) setProgress('progressMood', moods.slice(0, 7).reduce((a, m) => a + m.mood, 0) / Math.min(7, moods.length), 10);
      if (sleeps.length > 0) setProgress('progressSleep', sleeps.slice(0, 7).reduce((a, s) => a + s.hours, 0) / Math.min(7, sleeps.length), 8);
      if (exercises.length > 0) setProgress('progressExercise', exercises.filter(e => new Date(e.date) > new Date(Date.now() - 7*24*60*60*1000)).reduce((a, e) => a + e.duration, 0) / 7, 30);
      if (medsTotal > 0) setProgress('progressMeds', medsTaken, medsTotal);

      // Insights
      const insights = [];
      if (todayMood && todayMood.mood >= 7) insights.push({ type: 'positive', text: 'üåü Great mood today! Keep it up!' });
      if (todayMood && todayMood.mood <= 3) insights.push({ type: 'negative', text: 'üíô Tough day? Remember, it\'s okay to not be okay.' });
      if (todaySleep && todaySleep.hours >= 7) insights.push({ type: 'positive', text: 'üò¥ Excellent sleep! Well rested.' });
      if (todaySleep && todaySleep.hours < 6) insights.push({ type: 'warning', text: '‚ö†Ô∏è You need more sleep. Aim for 7-8 hours.' });
      if (todayExercise >= 30) insights.push({ type: 'positive', text: 'üí™ You hit your exercise goal today!' });
      if (todayExercise === 0) insights.push({ type: 'warning', text: 'üèÉ No exercise logged. A short walk counts!' });
      if (medsTotal > 0 && medsTaken < medsTotal) insights.push({ type: 'warning', text: 'üíä Remember to take all your medications.' });
      if (medsTotal > 0 && medsTaken === medsTotal) insights.push({ type: 'positive', text: '‚úÖ All medications taken!' });

      if (insights.length === 0) insights.push({ type: 'info', text: 'üìä Start logging data to see personalized insights!' });

      document.getElementById('insightsList').innerHTML = insights.map(i => `<div class="insight ${i.type}">${i.text}</div>`).join('');
      
      // Update streak chart when dashboard is updated
      updateStreakChart();
      
      // Update wellness trends chart
      createWellnessTrendChart();
    }

    // Initialize
    console.log('=== Starting initialization ===');
    
    // Load local medications database
    loadLocalMedicationsDB().then(() => {
      console.log('‚úì Local medications database loaded');
    }).catch(error => {
      console.warn('‚ö†Ô∏è Failed to load local medications database:', error);
    });
    
    migrateMedicationsToDefinitions(); // Migrate old medication data to new system
    generateTodaysDoses(); // Auto-generate today's pending doses
    initTheme();
    displayTip();
    loadMoodHistory();
    loadMedications();
    loadSleepData();
    loadExerciseData();
    updateDashboard();
    updateProfile();
    updateStreakChart();
    moodEmoji.textContent = moodEmojis[4];
    showOnboarding();
    
    // Verify medication search elements after initialization
    console.log('=== Verifying medication search elements ===');
    const verifyMedName = document.getElementById('medName');
    const verifyMedType = document.getElementById('medType');
    const verifyMedTypeHint = document.getElementById('medTypeHint');
    const verifyMedDosage = document.getElementById('medDosage');
    const verifyMedSearchResults = document.getElementById('medSearchResults');
    const verifyMedSearchResultsList = document.getElementById('medSearchResultsList');
    const verifyMedInfoBox = document.getElementById('medInfoBox');
    
    console.log('medName:', verifyMedName ? '‚úì Found' : '‚ùå NOT FOUND');
    console.log('medType:', verifyMedType ? '‚úì Found' : '‚ùå NOT FOUND');
    console.log('medTypeHint:', verifyMedTypeHint ? '‚úì Found' : '‚ùå NOT FOUND');
    console.log('medDosage:', verifyMedDosage ? '‚úì Found' : '‚ùå NOT FOUND');
    console.log('medSearchResults:', verifyMedSearchResults ? '‚úì Found' : '‚ùå NOT FOUND');
    console.log('medSearchResultsList:', verifyMedSearchResultsList ? '‚úì Found' : '‚ùå NOT FOUND');
    console.log('medInfoBox:', verifyMedInfoBox ? '‚úì Found' : '‚ùå NOT FOUND');
    
    if (verifyMedName) {
      console.log('medName input value:', verifyMedName.value);
      console.log('medName oninput handler:', verifyMedName.oninput);
      console.log('medName getAttribute("oninput"):', verifyMedName.getAttribute('oninput'));
    }

    // Close medication dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const medNameInput = document.getElementById('medName');
      const medSearchResults = document.getElementById('medSearchResults');
      
      if (medSearchResults && medNameInput && 
          !medNameInput.contains(e.target) && 
          !medSearchResults.contains(e.target)) {
        console.log('Click outside detected, hiding dropdown');
        medSearchResults.style.display = 'none';
      }
    });
    
    console.log('‚úì Medication search initialization complete');
    console.log('‚úì Click-outside handler registered');
    console.log('‚úì searchMedication function:', typeof window.searchMedication);
  </script>
</body>
</html>
